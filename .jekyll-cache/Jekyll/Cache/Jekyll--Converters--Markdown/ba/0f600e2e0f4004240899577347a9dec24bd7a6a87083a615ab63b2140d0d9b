I"iú<p>,,,,â€”
layout: post
title: â€œcomputer system1â€
subtitle: â€œnoteâ€
date: 2021-08-08
author: â€œthomasliaoâ€
header-img: â€œimg/post-bg-2015.jpgâ€
tags:
    - Android
    - Anki
â€”</p>

<h1 id="android">Android</h1>

<h2 id="contextclass">context:class</h2>

<p><img src="../images/context_class.png" alt="context0.png" /></p>

<h2 id="contextcontextæ•°é‡">context:contextæ•°é‡</h2>
<p>ä¸€èˆ¬éƒ½è®¤ä¸ºæ˜¯ï¼šactivityæ•°ç›®+Serviceæ•°ç›®+Applicationæ•°ç›®ã€‚è™½ç„¶activityå’Œserviceï¼Œapplicationéƒ½é—´æ¥ç»§æ‰¿contextã€‚ä½†æ˜¯ä»…ä»…ç”¨æ¥ç»´æŠ¤å…¶ç”Ÿå‘½å‘¨æœŸã€‚å†…éƒ¨contextçš„æˆå‘˜å˜é‡æ‰æ˜¯æˆ‘ä»¬æƒ³è¦çš„ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚</p>

<p><img src="../images/android_activity_class.png" alt="context1.png" /></p>

<h2 id="contextcontext-scope">context:context scope</h2>
<p><img src="../images/android_context_scope.png" alt="context2.png" /></p>

<h3 id="å¦‚æœæˆ‘ä»¬ç”¨applicationcontextå»å¯åŠ¨ä¸€ä¸ªlaunchmodeä¸ºstandardçš„activityçš„æ—¶å€™ä¼šæŠ¥é”™">å¦‚æœæˆ‘ä»¬ç”¨ApplicationContextå»å¯åŠ¨ä¸€ä¸ªLaunchModeä¸ºstandardçš„Activityçš„æ—¶å€™ä¼šæŠ¥é”™</h3>
<p>android.util.AndroidRuntimeException: Calling startActivity from outside of an Activity context requires the FLAG_ACTIVITY_NEW_TASK flag. Is this really what you want?</p>

<h3 id="åœ¨applicationå’Œserviceä¸­å»layout-inflateä¹Ÿæ˜¯åˆæ³•çš„ä½†æ˜¯ä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ä¸»é¢˜æ ·å¼å¦‚æœä½ è‡ªå®šä¹‰äº†æŸäº›æ ·å¼å¯èƒ½ä¸ä¼šè¢«ä½¿ç”¨æ‰€ä»¥è¿™ç§æ–¹å¼ä¹Ÿä¸æ¨èä½¿ç”¨">åœ¨Applicationå’ŒServiceä¸­å»layout inflateä¹Ÿæ˜¯åˆæ³•çš„ï¼Œä½†æ˜¯ä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ä¸»é¢˜æ ·å¼ï¼Œå¦‚æœä½ è‡ªå®šä¹‰äº†æŸäº›æ ·å¼å¯èƒ½ä¸ä¼šè¢«ä½¿ç”¨ã€‚æ‰€ä»¥è¿™ç§æ–¹å¼ä¹Ÿä¸æ¨èä½¿ç”¨ã€‚</h3>

<p>ä¸€å¥è¯æ€»ç»“ï¼šå‡¡æ˜¯è·ŸUIç›¸å…³çš„ï¼Œéƒ½åº”è¯¥ä½¿ç”¨Activityåšä¸ºContextæ¥å¤„ç†ï¼›å…¶ä»–çš„ä¸€äº›æ“ä½œï¼ŒService,Activity,Applicationç­‰å®ä¾‹éƒ½å¯ä»¥ï¼Œå½“ç„¶äº†ï¼Œæ³¨æ„Contextå¼•ç”¨çš„æŒæœ‰ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p>

<h3 id="ä¸€èˆ¬contexté€ æˆçš„å†…å­˜æ³„æ¼å‡ ä¹éƒ½æ˜¯å½“contexté”€æ¯çš„æ—¶å€™å´å› ä¸ºè¢«å¼•ç”¨å¯¼è‡´é”€æ¯å¤±è´¥è€Œapplicationçš„contextå¯¹è±¡å¯ä»¥ç†è§£ä¸ºéšç€è¿›ç¨‹å­˜åœ¨çš„æ‰€ä»¥æˆ‘ä»¬æ€»ç»“å‡ºä½¿ç”¨contextçš„æ­£ç¡®å§¿åŠ¿">ä¸€èˆ¬Contexté€ æˆçš„å†…å­˜æ³„æ¼ï¼Œå‡ ä¹éƒ½æ˜¯å½“Contexté”€æ¯çš„æ—¶å€™ï¼Œå´å› ä¸ºè¢«å¼•ç”¨å¯¼è‡´é”€æ¯å¤±è´¥ï¼Œè€ŒApplicationçš„Contextå¯¹è±¡å¯ä»¥ç†è§£ä¸ºéšç€è¿›ç¨‹å­˜åœ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ€»ç»“å‡ºä½¿ç”¨Contextçš„æ­£ç¡®å§¿åŠ¿ï¼š</h3>

<ul>
  <li>1ï¼šå½“Applicationçš„Contextèƒ½æå®šçš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸”ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ï¼Œä¼˜å…ˆä½¿ç”¨Applicationçš„Contextã€‚</li>
  <li>2ï¼šä¸è¦è®©ç”Ÿå‘½å‘¨æœŸé•¿äºActivityçš„å¯¹è±¡æŒæœ‰åˆ°Activityçš„å¼•ç”¨ã€‚</li>
  <li>3ï¼šå°½é‡ä¸è¦åœ¨Activityä¸­ä½¿ç”¨éé™æ€å†…éƒ¨ç±»ï¼Œå› ä¸ºéé™æ€å†…éƒ¨ç±»ä¼šéšå¼æŒæœ‰å¤–éƒ¨ç±»å®ä¾‹çš„å¼•ç”¨ï¼Œå¦‚æœä½¿ç”¨é™æ€å†…éƒ¨ç±»ï¼Œå°†å¤–éƒ¨å®ä¾‹å¼•ç”¨ä½œä¸ºå¼±å¼•ç”¨æŒæœ‰ã€‚</li>
</ul>

<h2 id="bitmap">Bitmap</h2>
<p>Bitmapåœ¨androidä¸­æŒ‡çš„æ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œå¯ä»¥æ˜¯pngæ ¼å¼ä¹Ÿå¯ä»¥æ˜¯jpeç­‰å…¶ä»–å¸¸ç”¨æ ¼å¼</p>

<h3 id="bitmapåƒç´ æ ¼å¼">Bitmapåƒç´ æ ¼å¼</h3>

<ul>
  <li>ALPHA_8ï¼šé¢œè‰²ä¿¡æ¯åªç”±é€æ˜åº¦ç»„æˆï¼Œå 8ä½</li>
  <li>ARGB_4444ï¼šé¢œè‰²ä¿¡æ¯ç”±é€æ˜åº¦ä¸Rï¼ˆRedï¼‰ï¼ŒGï¼ˆGreenï¼‰ï¼ŒBï¼ˆBlueï¼‰å››éƒ¨åˆ†ç»„æˆï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½å 4ä½ï¼Œæ€»å…±å 16ä½</li>
  <li>ARGB_8888ï¼šé¢œè‰²ä¿¡æ¯ç”±é€æ˜åº¦ä¸Rï¼ˆRedï¼‰ï¼ŒGï¼ˆGreenï¼‰ï¼ŒBï¼ˆBlueï¼‰å››éƒ¨åˆ†ç»„æˆï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½å 8ä½ï¼Œæ€»å…±å 32ä½ã€‚æ˜¯Bitmapé»˜è®¤çš„é¢œè‰²é…ç½®ä¿¡æ¯ï¼Œä¹Ÿæ˜¯æœ€å ç©ºé—´çš„ä¸€ç§é…ç½®</li>
  <li>RGB_565ï¼šé¢œè‰²ä¿¡æ¯ç”±Rï¼ˆRedï¼‰ï¼ŒGï¼ˆGreenï¼‰ï¼ŒBï¼ˆBlueï¼‰ä¸‰éƒ¨åˆ†ç»„æˆï¼ŒRå 5ä½ï¼ŒGå 6ä½ï¼ŒBå 5ä½ï¼Œæ€»å…±å 16ä½</li>
</ul>

<h3 id="bitmapå†…å­˜å¤§å°è®¡ç®—">Bitmapå†…å­˜å¤§å°è®¡ç®—</h3>
<p>å›¾ç‰‡é•¿åº¦ x å›¾ç‰‡å®½åº¦ x ä¸€ä¸ªåƒç´ ç‚¹å ç”¨çš„å­—èŠ‚æ•°</p>

<h3 id="åŠ è½½bitmap">åŠ è½½Bitmap</h3>

<ul>
  <li>decodeFile
    <ul>
      <li>è°ƒç”¨äº†decodeStream</li>
    </ul>
  </li>
  <li>decodeResource
    <ul>
      <li>è°ƒç”¨äº†decodeStream</li>
    </ul>
  </li>
  <li>decodeStream</li>
  <li>decodeByteArray</li>
</ul>

<h2 id="bitmapé«˜æ•ˆåŠ è½½bitmap">Bitmap:é«˜æ•ˆåŠ è½½Bitmap</h2>

<ul>
  <li>é€šè¿‡é‡‡æ ·ç‡é«˜æ•ˆåŠ è½½
    <ul>
      <li>å°†BitmapFactory.Optionsçš„inJustDecodeBoundså‚æ•°è®¾ä¸ºtrueå¹¶åŠ è½½å›¾ç‰‡
        <ul>
          <li>BitmapFactoryåªä¼šè§£æå›¾ç‰‡çš„åŸå§‹å®½/é«˜ä¿¡æ¯ï¼Œå¹¶ä¸ä¼šå»çœŸæ­£åœ°åŠ è½½å›¾ç‰‡ï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œæ˜¯è½»é‡çº§çš„</li>
        </ul>
      </li>
      <li>ä»BitmapFactory.Optionsä¸­å–å‡ºå›¾ç‰‡çš„åŸå§‹å®½é«˜ä¿¡æ¯ï¼Œå®ƒä»¬å¯¹åº”äºoutWidthå’ŒoutHeightå‚æ•°</li>
      <li>æ ¹æ®é‡‡æ ·ç‡çš„è§„åˆ™å¹¶ç»“åˆç›®æ ‡Viewçš„æ‰€éœ€å¤§å°è®¡ç®—å‡ºé‡‡æ ·ç‡inSampleSize</li>
      <li>å°†BitmapFactory.Optionsçš„inJustDecodeBoundså‚æ•°è®¾ä¸ºfalseï¼Œç„¶åé‡æ–°åŠ è½½å›¾ç‰‡</li>
    </ul>
  </li>
  <li>å†…å­˜å¤ç”¨
    <ul>
      <li>åœ¨Bitmapä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å­—æ®µBitmapFactory.Options.inBitmapï¼Œè®¾ç½®æ­¤å­—æ®µä¸ºtrueåï¼Œè§£ç æ–¹æ³•ä¼šå°è¯•å¤ç”¨ä¸€å¼ å­˜åœ¨çš„Bitmap</li>
    </ul>
  </li>
  <li>ä½¿ç”¨ç¼“å­˜
    <ul>
      <li>LruCache-LruCacheä½œä¸ºBitmapåœ¨å†…å­˜ä¸­çš„å­˜æ”¾å®¹å™¨</li>
      <li>DiskLruCache-åœ¨sdå¡åˆ™ä½¿ç”¨DiskLruCacheæ¥ç»Ÿä¸€ç®¡ç†ç£ç›˜ä¸Šçš„å›¾ç‰‡ç¼“å­˜</li>
    </ul>
  </li>
  <li>å†…å­˜å¤ç”¨ + ç¼“å­˜
    <ul>
      <li>ç¼“å­˜ä¸­å³å°†å›æ”¶çš„ä½¿ç”¨å¼±å¼•ç”¨(å†…å­˜ä¸è¶³æ—¶ä¼šGC), è®¾ç½®inBitmapæ¥å¤ç”¨å†…å­˜</li>
    </ul>
  </li>
</ul>

<h2 id="bitmapå‹ç¼©å›¾ç‰‡">Bitmap:å‹ç¼©å›¾ç‰‡</h2>
<p>å…ˆå°ºå¯¸å‹ç¼©ï¼Œåè´¨é‡å‹ç¼©ï¼Œå› ä¸ºå°ºå¯¸å‹ç¼©å¯ä»¥è®¾ç½®<code class="language-plaintext highlighter-rouge">options.inJustDecodeBounds = true</code>ä»…è·å– Bitmap åŸºæœ¬ä¿¡æ¯ï¼Œå‡ ä¹ä¸å ç”¨åº”ç”¨ç¨‹åºçš„è¿è¡Œå†…å­˜</p>

<ul>
  <li>è´¨é‡å‹ç¼©
    <ul>
      <li>ä¸æ”¹å˜å›¾ç‰‡çš„å°ºå¯¸</li>
      <li><code class="language-plaintext highlighter-rouge">Bitmap.compress(CompressFormat format, int quality, OutputStream stream)</code>
        <ul>
          <li>é€šè¿‡ä¸æ–­è¾ƒå°‘ quality æ¥é™åˆ¶æ–‡ä»¶å¤§å°</li>
          <li>å‡å¦‚å›¾ç‰‡ç‰¹åˆ«å¤§ï¼Œå½“æ‰§è¡ŒByteArrayOutputStream.toByteArray() è¿™è¡Œæ—¶å¾ˆå¯èƒ½ OOM</li>
          <li>æ‰€ä»¥è´¨é‡å‹ç¼©ä¸èƒ½å…ˆæ‰§è¡Œ</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>å°ºå¯¸å‹ç¼©
    <ul>
      <li>ä¸€èˆ¬ç”¨äºç”Ÿæˆç¼©ç•¥å›¾</li>
      <li>é€šè¿‡ç¼©æ”¾å›¾ç‰‡åƒç´ æ¥å‡å°‘å›¾ç‰‡å ç”¨å†…å­˜å¤§å°</li>
      <li>è·å–å›¾ç‰‡çš„ä¸€äº›å±æ€§ï¼Œä¾‹å¦‚å›¾ç‰‡å®½é«˜ï¼Œå›¾ç‰‡ç±»å‹ç­‰ç­‰ï¼ˆinJustDecodeBoundså‚æ•°è®¾ä¸ºtrueï¼‰
        <ul>
          <li>åŸºäºå½“å‰çš„ä¸Šä¸‹æ–‡æ¥å†³å®šæ€ä¹ˆåŠ è½½å›¾ç‰‡â€”å®Œæ•´ã€å‹ç¼©ã€æ€ä¹ˆå‹ç¼©(é‡‡æ ·ç‡inSampleSize)
            <ul>
              <li>å®Œæ•´å›¾ç‰‡åŠ è½½åˆ°å†…å­˜ä¸­æ‰€ä½¿ç”¨å†…å­˜ vs å¯åˆ†é…å†…å­˜</li>
              <li>æ˜¾ç¤ºå›¾ç‰‡çš„æ§ä»¶çš„å¤§å°</li>
              <li>å½“å‰è®¾å¤‡çš„å±å¹•å¤§å°å’Œå¯†åº¦</li>
            </ul>
          </li>
          <li>è®¡ç®—é‡‡æ ·ç‡inSampleSize
            <ul>
              <li>Android æºç è®¡ç®—æ–¹å¼</li>
              <li>å¸¸è§„ç®—æ³•</li>
              <li>luban</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="bitmapå±€éƒ¨åŠ è½½">Bitmap:å±€éƒ¨åŠ è½½</h2>
<p>å•ä¸ªå›¾ç‰‡éå¸¸å·¨å¤§ï¼Œå¹¶ä¸”è¿˜ä¸å…è®¸å‹ç¼©ã€‚æ¯”å¦‚æ˜¾ç¤ºï¼šä¸–ç•Œåœ°å›¾ã€æ¸…æ˜ä¸Šæ²³å›¾ã€å¾®åšé•¿å›¾ç­‰</p>

<ul>
  <li><a href="https://blog.csdn.net/lmj623565791/article/details/49300989">BitmapRegionDecoder</a></li>
  <li>æ ¹æ®å±å¹•å¤§å°å°†è¿™ä¸ªå›¾åˆ‡æˆNå¤šå—ï¼Œè¦åŠ è½½æ—¶æ ¹æ®å±å¹•æ»‘åŠ¨åŠ è½½ï¼Œç±»ä¼¼äºç›®å‰å¸¸ç”¨çš„è°·æ­Œåœ°å›¾æ–¹å¼
    <ul>
      <li>è¿˜å¯ä»¥å®ç°bitmapå¤ç”¨</li>
    </ul>
  </li>
</ul>

<h2 id="bitmap-getbytecount-vsgetallocationbytecount">Bitmap: <strong>getByteCount vsÂ getAllocationByteCount</strong></h2>
<h3 id="ä¸€èˆ¬æƒ…å†µä¸‹getbytecountå’Œgetallocationbytecountæ˜¯ç›¸ç­‰çš„ä½†æ˜¯bitmapå†…å­˜å¦‚æœå¤ç”¨ä¹‹åä¸¤è€…å°±ä¸ä¸€æ ·äº†">ä¸€èˆ¬æƒ…å†µä¸‹getByteCount()å’ŒgetAllocationByteCount()æ˜¯ç›¸ç­‰çš„ã€‚ä½†æ˜¯Bitmapå†…å­˜å¦‚æœå¤ç”¨ä¹‹åï¼Œä¸¤è€…å°±ä¸ä¸€æ ·äº†</h3>

<ul>
  <li>getByteCount()ä»£è¡¨å­˜å‚¨Bitmapçš„è‰²ç´ éœ€è¦çš„æœ€å°‘å†…å­˜</li>
  <li>getAllocationByteCount()ä»£è¡¨åœ¨å†…å­˜ä¸­ä¸ºBitmapåˆ†é…çš„å†…å­˜å¤§å°</li>
</ul>

<h3 id="é€šè¿‡å¤ç”¨bitmapæ¥è§£ç å›¾ç‰‡å¦‚æœè¢«å¤ç”¨çš„bitmapçš„å†…å­˜æ¯”å¾…åˆ†é…å†…å­˜çš„bitmapå¤§">é€šè¿‡å¤ç”¨Bitmapæ¥è§£ç å›¾ç‰‡ï¼Œå¦‚æœè¢«å¤ç”¨çš„Bitmapçš„å†…å­˜æ¯”å¾…åˆ†é…å†…å­˜çš„Bitmapå¤§</h3>

<ul>
  <li>getByteCount()è¡¨ç¤ºæ–°è§£ç å›¾ç‰‡å ç”¨å†…å­˜çš„å¤§å°</li>
  <li>getAllocationByteCount()è¡¨ç¤ºè¢«å¤ç”¨BitmapçœŸå®å ç”¨çš„å†…å­˜å¤§å°</li>
</ul>

<h2 id="bitmapandroid-bitmapå†…å­˜åˆ†é…å˜åŒ–">Bitmap:Android Bitmapå†…å­˜åˆ†é…å˜åŒ–</h2>

<ul>
  <li>Android3.0ä¹‹å‰ï¼Œ Bitmapå¯¹è±¡æ”¾åœ¨Javaå †ï¼Œåƒç´ æ•°æ®æ”¾åœ¨Nativeå†…å­˜
    <ul>
      <li>æ‰‹åŠ¨è°ƒç”¨recycleé‡Šæ”¾</li>
    </ul>
  </li>
  <li>Android3.0â€“Android7.0 å¯¹è±¡å’Œåƒç´ æ•°æ®ç»Ÿä¸€ï¼Œæ”¾åˆ°Javaå †ä¸­
    <ul>
      <li>å°±ç®—ä¸è°ƒç”¨recycleï¼ŒBitmapå†…å­˜ä¹Ÿä¼šéšå¯¹è±¡ä¸€èµ·è¢«å›æ”¶</li>
      <li>Bitmapæ¶ˆè€—å†…å­˜å¤§ï¼Œæ‰€ä»¥æ”¾åœ¨Javaå †æ¯”è¾ƒå®¹æ˜“å¯¼è‡´OOMã€å¤§é‡GC</li>
    </ul>
  </li>
  <li>Android 8.0 é‡æ–°å°† Bitmap å†…å­˜æ”¾å›åˆ° Native ä¸­</li>
  <li>ä¼˜åŒ–3.0â€“7.0
    <ul>
      <li>é€šè¿‡ç›´æ¥è°ƒç”¨ libandroid_runtime.so ä¸­ Bitmap çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥å¾—åˆ°ä¸€å¼ ç©ºçš„ Bitmap å¯¹è±¡ï¼Œè€Œå®ƒçš„å†…å­˜æ˜¯æ”¾åˆ° Native å †ä¸­</li>
      <li>é€šè¿‡ç³»ç»Ÿçš„æ–¹æ³•åˆ›å»ºä¸€å¼ æ™®é€šçš„ Java Bitmap</li>
      <li>å°† Java Bitmap çš„å†…å®¹ç»˜åˆ¶åˆ°ä¹‹å‰ç”³è¯·çš„ç©ºçš„ Native Bitmap ä¸­</li>
      <li>å°†ç”³è¯·çš„ Java Bitmap é‡Šæ”¾ï¼Œå®ç°å›¾ç‰‡å†…å­˜çš„â€œå·é¾™è½¬å‡¤â€ã€‚</li>
      <li>è¿™ä¸ªâ€œé»‘ç§‘æŠ€â€æœ‰ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯å…¼å®¹æ€§é—®é¢˜ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯é¢‘ç¹ç”³è¯·é‡Šæ”¾ Java Bitmap å®¹æ˜“å¯¼è‡´å†…å­˜æŠ–åŠ¨</li>
    </ul>
  </li>
</ul>

<h2 id="bitmapå‡å°‘å†…å­˜å ç”¨">Bitmap:å‡å°‘å†…å­˜å ç”¨</h2>

<ul>
  <li>ä½¿ç”¨é‡‡æ · + RGB_565
    <ul>
      <li><strong>é‡‡æ ·ä¹‹åå†…å­˜æ˜¯å°äº†ï¼Œå¯æ˜¯å›¾çš„å°ºå¯¸ä¹Ÿå°äº†ï¼Œå¯ä»¥ä½¿ç”¨çŸ©é˜µï¼Œå†…å­˜ä¸å˜ï¼Œæ”¾å¤§å›¾ç‰‡</strong></li>
    </ul>
  </li>
</ul>

<p>**</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">//canvas</span>
<span class="nc">Matrix</span> <span class="n">matrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Matrix</span><span class="o">();</span>
<span class="n">matrix</span><span class="o">.</span><span class="na">preScale</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="n">canvas</span><span class="o">.</span><span class="na">drawBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">,</span> <span class="n">matrix</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
<span class="c1">//ImageView</span>
<span class="nc">Matrix</span> <span class="n">matrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Matrix</span><span class="o">();</span>
<span class="n">matrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="n">imageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">matrix</span><span class="o">);</span>
<span class="n">imageView</span><span class="o">.</span><span class="na">setScaleType</span><span class="o">(</span><span class="nc">ScaleType</span><span class="o">.</span><span class="na">MATRIX</span><span class="o">);</span>
<span class="n">imageView</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="bitmapå†…å­˜ä¼˜åŒ–">Bitmap:å†…å­˜ä¼˜åŒ–</h2>

<ul>
  <li>å»é™¤é‡å¤å›¾ç‰‡
    <ul>
      <li>æ£€æŸ¥å›¾ç‰‡å°ºå¯¸+bitmapæ•°ç»„è¿›è¡Œhashå¯¹æ¯”</li>
    </ul>
  </li>
  <li>å¤§å›¾ç‰‡ç›‘æ§
    <ul>
      <li>æ’æ¡©æ–¹å¼åœ¨setBitmapæ–¹æ³•åæ‹¿åˆ°bitmapçš„å®½é«˜å’Œviewçš„å®½é«˜åšæ¯”è¾ƒ</li>
      <li>å®šæ—¶å»è·å–å†…å­˜å¿«ç…§ä¸­viewå’Œbitmapä¸­å®½é«˜ä½œæ¯”è¾ƒ</li>
    </ul>
  </li>
</ul>

<h2 id="activity-lifecycle">Activity lifecycle</h2>

<p><img src="../images/activity_lifecycle.png" alt="image.png" /></p>

<blockquote>
  <p>æ³¨æ„ï¼Œå½“ç³»ç»Ÿå› ä¸ºå†…å­˜ä¸è¶³ï¼ˆä¼˜å…ˆçº§æ›´é«˜çš„åº”ç”¨éœ€è¦å†…å­˜ï¼Œè¯·çœ‹ä¸Šå›¾çº¢æ¡†ï¼‰è¦å›æ”¶Activityå ç”¨çš„èµ„æºæ—¶ï¼ŒActivityåœ¨æ‰§è¡Œå®ŒonPause()æ–¹æ³•åå°±ä¼šè¢«é”€æ¯ï¼Œæœ‰äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•onStop()ï¼ŒonDestory()å°±ä¸ä¼šæ‰§è¡Œã€‚å½“å†å›åˆ°æ­¤Activityæ—¶ï¼Œæ˜¯ä»onCreateæ–¹æ³•å¼€å§‹æ‰§è¡Œ</p>
</blockquote>

<h2 id="activity-lifecycleç”Ÿå‘½å‘¨æœŸ">Activity lifecycle:ç”Ÿå‘½å‘¨æœŸ</h2>

<ul>
  <li>onCreate
    <ul>
      <li>è¡¨ç¤ºactivityæ­£åœ¨è¢«åˆ›å»º</li>
      <li>åˆå§‹åŒ–å·¥ä½œï¼šsetContentViewã€åˆå§‹åŒ–Activityéœ€è¦çš„æ•°æ®</li>
    </ul>
  </li>
  <li>onRestart
    <ul>
      <li>è¡¨ç¤ºé‡æ–°åˆ›å»º</li>
      <li>Activityä»ä¸å¯è§é‡æ–°å˜ä¸ºå¯è§æ‰ä¼šè°ƒç”¨</li>
      <li>ä¸€èˆ¬æ˜¯ç”¨æˆ·æ‰€è‡´ï¼Œå¦‚æŒ‰ä¸‹homeé”®</li>
    </ul>
  </li>
  <li>onStart
    <ul>
      <li>æ­£åœ¨å¯åŠ¨</li>
      <li>Activityåœ¨åå°â€“å·²ç»å¯è§ä½†æ˜¯æ²¡å‡ºç°åœ¨å‰å°ã€æ— æ³•å’Œç”¨æˆ·äº¤äº’</li>
      <li>å¯ä»¥ç†è§£ä¸ºActivityå·²ç»æ˜¾ç¤ºå‡ºæ¥ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹ä¸åˆ°</li>
    </ul>
  </li>
  <li>onResume
    <ul>
      <li>å·²ç»å¯è§ï¼Œå¹¶ä¸”åœ¨å‰å°å¼€å§‹æ´»åŠ¨</li>
    </ul>
  </li>
  <li>onPause
    <ul>
      <li>è¡¨ç¤ºActivityæ­£åœ¨åœæ­¢</li>
      <li>å¯ä»¥åšä¸€äº›å­˜å‚¨æ•°æ®ã€åœæ­¢åŠ¨ç”»ç­‰</li>
      <li>æ³¨æ„ä¸èƒ½å¤ªè€—æ—¶ï¼Œä¼šå½±å“æ–°Activityçš„æ˜¾ç¤ºâ€“onPauseå¿…é¡»æ‰§è¡Œå®Œï¼Œæ–°çš„Activity onResumeæ‰ä¼šæ‰§è¡Œ</li>
    </ul>
  </li>
  <li>onStop
    <ul>
      <li>è¡¨ç¤ºActivityå³å°†åœæ­¢</li>
      <li>å¯ä»¥åšä¸€äº›ç¨å¾®é‡é‡çº§çš„å›æ”¶å·¥ä½œï¼ŒåŒæ ·ä¸èƒ½å¤ªè€—æ—¶</li>
    </ul>
  </li>
  <li>onDestroy
    <ul>
      <li>è¡¨ç¤ºActivityå³å°†è¢«é”€æ¯</li>
      <li>å›æ”¶å·¥ä½œå’Œæœ€ç»ˆçš„èµ„æºé‡Šæ”¾</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>onStartå’ŒonStopæ˜¯ä»Activityæ˜¯å¦å¯è§è¿™ä¸ªè§’åº¦æ¥å›è°ƒçš„ï¼Œè€ŒonResumeå’ŒonPauseæ˜¯ä»Activityæ˜¯å¦ä½äºå‰å°è¿™ä¸ªè§’åº¦æ¥å›è°ƒçš„ï¼Œé™¤äº†è¿™ç§åŒºåˆ«ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­æ²¡æœ‰å…¶ä»–æ˜æ˜¾åŒºåˆ«</p>
</blockquote>

<h2 id="activity-lifecycleç”Ÿå‘½å‘¨æœŸåˆ‡æ¢è¿‡ç¨‹">Activity lifecycle:ç”Ÿå‘½å‘¨æœŸåˆ‡æ¢è¿‡ç¨‹</h2>

<ul>
  <li>é’ˆå¯¹ä¸€ä¸ªç‰¹å®šçš„Activityï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œå›è°ƒå¦‚ä¸‹ï¼šonCreate&gt;onStart&gt;onResume</li>
  <li>æ‰“å¼€æ–°çš„Activityæˆ–è€…åˆ‡æ¢åˆ°æ¡Œé¢çš„æ—¶å€™ï¼Œå›è°ƒå¦‚ä¸‹ï¼šonPause&gt;onStopã€‚
    <ul>
      <li>ç‰¹æ®Šæƒ…å†µï¼šå¦‚æœæ–°Activityé‡‡ç”¨äº†é€æ˜ä¸»é¢˜ï¼Œé‚£ä¹ˆå½“å‰Activityä¸ä¼šå›è°ƒonStop</li>
    </ul>
  </li>
  <li>å½“ç”¨æˆ·å†æ¬¡å›åˆ°åŸActivityæ—¶ï¼Œå›è°ƒå¦‚ä¸‹ï¼šonRestart&gt;onStart&gt;onResume</li>
  <li>å½“ç”¨æˆ·æŒ‰backé”®å›é€€æ—¶ï¼Œå›è°ƒå¦‚ä¸‹ï¼šonPause&gt;onStop&gt;onDestroy</li>
  <li>pair
    <ul>
      <li>onCreateå’ŒonDestroyï¼Œ æ ‡è¯†Activityçš„åˆ›å»ºå’Œé”€æ¯</li>
      <li>æ˜¯å¦å¯è§ï¼šonStartå’ŒonStopï¼Œ éšç€ç”¨æˆ·æ“ä½œå’Œè®¾å¤‡å±å¹•ç‚¹äº®å’Œç†„ç­ï¼Œå¯èƒ½è°ƒç”¨å¤šæ¬¡</li>
      <li>æ˜¯å¦åœ¨å‰å°: onResumeå’ŒonPause,Â éšç€ç”¨æˆ·æ“ä½œå’Œè®¾å¤‡å±å¹•ç‚¹äº®å’Œç†„ç­ï¼Œå¯èƒ½è°ƒç”¨å¤šæ¬¡</li>
    </ul>
  </li>
</ul>

<h2 id="activity-lifecycleactivityå¼‚å¸¸ç»“æŸ">Activity lifecycle:Activityå¼‚å¸¸ç»“æŸ</h2>

<ul>
  <li>æ—¶æœº
    <ul>
      <li>ç³»ç»Ÿå›æ”¶Activity</li>
      <li>è®¾å¤‡çš„Configurationæ”¹å˜å¯¼è‡´Activityé”€æ¯é‡å»º
        <ul>
          <li>
            <table>
              <tbody>
                <tr>
                  <td>å¿…é¡»è®¾ç½®ä¸ºandroid:configChanges=â€orientation</td>
                  <td>screenSizeâ€æ—¶ï¼Œä¸ä¼šé‡èµ°ç”Ÿå‘½å‘¨æœŸ</td>
                </tr>
              </tbody>
            </table>
            <ul>
              <li>åªä¼šå›è°ƒonConfigurationChangedæ–¹æ³•</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>æµç¨‹
    <ul>
      <li><strong>onStopä¹‹å‰</strong>å›è°ƒ<strong>onSaveInstanceState</strong>ä¿å­˜æ•°æ®</li>
      <li><strong>åœ¨onStartä¹‹å</strong>å›è°ƒ<strong>onRestoreInstanceState</strong></li>
      <li>å…¶ä¸­Bundleæ•°æ®ä¼šä¼ åˆ°onCreateï¼ˆä¸ä¸€å®šæœ‰æ•°æ®ï¼‰å’ŒonRestoreInstanceStateï¼ˆä¸€å®šæœ‰æ•°æ®ï¼‰</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * saveInstance ä¸ä¸€å®šæœ‰æ•°æ®
     * @param saveInstance
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">saveInstance</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">saveInstance</span><span class="o">);</span>

        <span class="c1">// Check whether we're recreating a previously destroyed instance</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">saveInstance</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Restore value of members from saved state</span>
            <span class="n">mUser</span> <span class="o">=</span> <span class="n">saveInstance</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">STATE_USER</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Probably initialize members with default values for a new instance</span>
            <span class="n">mUser</span> <span class="o">=</span> <span class="s">"NewUser"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">outState</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="no">STATE_USER</span><span class="o">,</span> <span class="n">mUser</span><span class="o">);</span>
        <span class="c1">//onStopä¹‹å‰è°ƒç”¨</span>
        <span class="c1">// Always call the superclass so it can save the view hierarchy state</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRestoreInstanceState</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onRestoreInstanceState</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="c1">//ä¸éœ€è¦åˆ¤æ–­savedInstanceStateï¼Œ åœ¨onStartåè°ƒç”¨</span>
        <span class="c1">// Restore value of members from saved state</span>
        <span class="n">mUser</span> <span class="o">=</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">STATE_USER</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><a href="https://www.jianshu.com/p/dedbae8ffca1">fragment</a></p>

<p><a href="https://www.jianshu.com/p/4c798c91a613">service</a></p>

<h2 id="service-lifecycle">service lifecycle</h2>
<p><img src="../images/service_lifecycle.png" alt="image.png" /></p>

<h2 id="service-æœ¬åœ°è¿œç¨‹">Service æœ¬åœ°ã€è¿œç¨‹</h2>

<ul>
  <li>æœ¬åœ°æœåŠ¡
    <ul>
      <li>è¯¥æœåŠ¡ä¾é™„åœ¨ä¸»è¿›ç¨‹ä¸Šè€Œä¸æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹</li>
      <li>ä¸éœ€è¦IPCï¼Œä¸éœ€è¦AIDL</li>
      <li>åº”ç”¨è¢«æ€ï¼Œserviceä¹Ÿä¼šè¢«æ€</li>
    </ul>
  </li>
  <li>è¿œç¨‹æœåŠ¡
    <ul>
      <li>ç‹¬ç«‹è¿›ç¨‹Â·</li>
      <li>å¯¹åº”è¿›ç¨‹åæ ¼å¼ä¸ºæ‰€åœ¨åŒ…ååŠ ä¸Šä½ æŒ‡å®šçš„android:processå­—ç¬¦ä¸²ã€‚ä¸€èˆ¬å®šä¹‰æ–¹å¼Â android:process=â€:serviceâ€</li>
      <li>Activityæ‰€åœ¨è¿›ç¨‹è¢«Killçš„æ—¶å€™ï¼Œè¯¥æœåŠ¡ä¾ç„¶åœ¨è¿è¡Œï¼Œä¸å—å…¶ä»–è¿›ç¨‹å½±å“</li>
    </ul>
  </li>
</ul>

<h2 id="serviceçŠ¶æ€">ServiceçŠ¶æ€</h2>

<ul>
  <li>å¯åŠ¨çŠ¶æ€
    <ul>
      <li><strong>é€šè¿‡è°ƒç”¨ startService() å¯åŠ¨æœåŠ¡æ—¶ï¼Œ</strong>æœåŠ¡å³å¤„äºâ€œå¯åŠ¨â€çŠ¶æ€</li>
      <li><strong>ä¸€æ—¦å¯åŠ¨ï¼ŒæœåŠ¡å³å¯åœ¨åå°æ— é™æœŸè¿è¡Œï¼Œå³ä½¿å¯åŠ¨æœåŠ¡çš„ç»„ä»¶å·²è¢«é”€æ¯ä¹Ÿä¸å—å½±å“ï¼Œé™¤éæ‰‹åŠ¨è°ƒç”¨æ‰èƒ½åœæ­¢æœåŠ¡</strong></li>
      <li>å¦‚æœæƒ³è¦å¯åŠ¨ä¸€ä¸ªåå°æœåŠ¡é•¿æœŸè¿›è¡ŒæŸé¡¹ä»»åŠ¡ï¼Œé‚£ä¹ˆä½¿ç”¨startService</li>
      <li><em>å¤šæ¬¡startServiceä¸ä¼šé‡å¤æ‰§è¡ŒonCreateå›è°ƒï¼Œä½†æ¯æ¬¡éƒ½ä¼šæ‰§è¡ŒonStartCommandå›è°ƒã€‚</em></li>
      <li>Â onCreate -&gt; onStartCommand -&gt; onDestoryÂ </li>
      <li>stopService</li>
    </ul>
  </li>
  <li>ç»‘å®šçŠ¶æ€
    <ul>
      <li>è°ƒç”¨ bindService() ç»‘å®šåˆ°æœåŠ¡æ—¶ï¼ŒæœåŠ¡å³å¤„äºâ€œç»‘å®šâ€çŠ¶æ€</li>
      <li><strong>ç»‘å®šæœåŠ¡æä¾›äº†ä¸€ä¸ªå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¥å£ï¼Œå…è®¸ç»„ä»¶ä¸æœåŠ¡è¿›è¡Œäº¤äº’ã€å‘é€è¯·æ±‚ã€è·å–ç»“æœï¼Œç”šè‡³æ˜¯åˆ©ç”¨è¿›ç¨‹é—´é€šä¿¡ (IPC) è·¨è¿›ç¨‹æ‰§è¡Œè¿™äº›æ“ä½œ</strong></li>
      <li>å¤šä¸ªç»„ä»¶<strong>å¯ä»¥åŒæ—¶ç»‘å®šåˆ°è¯¥æœåŠ¡</strong>ï¼Œä½†<strong>å…¨éƒ¨å–æ¶ˆç»‘å®šåï¼Œè¯¥æœåŠ¡å³ä¼šè¢«é”€æ¯</strong></li>
      <li>å¦‚æœåªæ˜¯çŸ­æš‚çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆä½¿ç”¨bindServiceã€‚</li>
      <li>onCreate -&gt; onBind -&gt; onUnbind -&gt; onDestory</li>
      <li>unbindService</li>
    </ul>
  </li>
  <li>å¯¹äºæ—¢ä½¿ç”¨startServiceï¼Œåˆä½¿ç”¨bindServiceçš„æƒ…å†µ,Serviceçš„ç»ˆæ­¢ï¼Œéœ€è¦unbindServiceå’ŒstopServiceéƒ½è°ƒç”¨æ‰è¡Œ</li>
</ul>

<h2 id="intentservice">IntentService</h2>

<blockquote>
  <p>IntentServiceæœ¬è´¨æ˜¯é‡‡ç”¨Handler &amp; HandlerThreadæ–¹å¼</p>
</blockquote>

<ul>
  <li>å†…éƒ¨composeäº†ServiceHandlerï¼Œå¹¶ä¸”åœ¨onCreateçš„æ—¶å€™åˆ›å»ºæ–°çº¿ç¨‹</li>
  <li>é‡å†™å…¶ä¸­çš„onHandleIntent(Intent)æ–¹æ³•æ¥æ”¶ä¸€ä¸ªIntentå¯¹è±¡,åœ¨é€‚å½“çš„æ—¶å€™ä¼šåœæ­¢è‡ªå·±(ä¸€èˆ¬åœ¨å·¥ä½œå®Œæˆçš„æ—¶å€™).</li>
  <li>onHandleIntent(Intent)æ‰§è¡Œåœ¨å­çº¿ç¨‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">IntentService</span> <span class="kd">extends</span> <span class="nc">Service</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Looper</span> <span class="n">mServiceLooper</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">ServiceHandler</span> <span class="n">mServiceHandler</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">mName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mRedelivery</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ServiceHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nf">ServiceHandler</span><span class="o">(</span><span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">looper</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">onHandleIntent</span><span class="o">((</span><span class="nc">Intent</span><span class="o">)</span><span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">);</span>
            <span class="n">stopSelf</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
        <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// TODO: It would be nice to have an option to hold a partial wakelock</span>
        <span class="c1">// during processing, and to have a static startService(Context, Intent)</span>
        <span class="c1">// method that would launch the service &amp; hand off a wakelock.</span>

        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        <span class="nc">HandlerThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HandlerThread</span><span class="o">(</span><span class="s">"IntentService["</span> <span class="o">+</span> <span class="n">mName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="n">mServiceLooper</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">();</span>
        <span class="n">mServiceHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceHandler</span><span class="o">(</span><span class="n">mServiceLooper</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>//ä½¿ç”¨IntentService
    private void testIntentService() {
        String inputText = editText.getText().toString();
        Intent inputIntent = new Intent(ServiceActivity.this, MyIntentService.class);
        inputIntent.putExtra(MyIntentService.TEXT_INPUT, inputText);
        startService(inputIntent);
    }
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="android-broadcast">android broadcast</h2>

<p><a href="https://blog.csdn.net/carson_ho/article/details/52973504?utm_medium=distribute.pc_relevant_right.none-task-blog-BlogCommendFromBaidu-1&amp;depth_1-utm_source=distribute.pc_relevant_right.none-task-blog-BlogCommendFromBaidu-1">Broadcast</a></p>

<ul>
  <li>å¹¿æ’­æ¥æ”¶è€…å’Œå¹¿æ’­å‘é€è€…çš„æ‰§è¡Œæ˜¯å¼‚æ­¥çš„</li>
  <li>åŠ¨æ€å¹¿æ’­æ˜¯åœ¨ä»£ç é‡Œæ³¨å†Œçš„ï¼Œé™æ€å¹¿æ’­æ˜¯åœ¨AndroidManifest.xmlï¼ˆæ¸…å•æ–‡ä»¶ï¼‰ä¸­æ³¨å†Œçš„ã€‚
    <ul>
      <li>åŠ¨æ€å¹¿æ’­æœ€å¥½åœ¨Activity çš„ onResume()æ³¨å†Œã€onPause()æ³¨é”€ã€‚
        <ul>
          <li>å¯¹äºåŠ¨æ€å¹¿æ’­ï¼Œæœ‰æ³¨å†Œå°±å¿…ç„¶å¾—æœ‰æ³¨é”€ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„éœ²</li>
          <li>ä¸åœ¨onCreate() &amp; onDestory() æˆ– onStart() &amp; onStop()æ³¨å†Œã€æ³¨é”€
            <ul>
              <li>å†…å­˜ä¸è¶³Activityåªè·‘onPause</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>åŠ¨æ€æ³¨å†Œå¹¿æ’­ä¸æ˜¯å¸¸é©»å‹å¹¿æ’­ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¿æ’­è·Ÿéš Activity çš„ç”Ÿå‘½å‘¨æœŸ
        <ul>
          <li>Â Activity ç»“æŸå‰ï¼Œç§»é™¤å¹¿æ’­æ¥æ”¶å™¨</li>
          <li>å¯ä»¥æ ¹æ®è‡ªå·±éœ€æ±‚ç‰¹å®šæ—¶åˆ»ç›‘å¬å¹¿æ’­</li>
        </ul>
      </li>
      <li>é™æ€æ³¨å†Œæ˜¯å¸¸é©»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“åº”ç”¨ç¨‹åºå…³é—­åï¼Œå¦‚æœæœ‰ä¿¡æ¯å¹¿æ’­æ¥ï¼Œç¨‹åºä¹Ÿä¼šè¢«ç³»ç»Ÿè°ƒç”¨è‡ªåŠ¨è¿è¡Œ
        <ul>
          <li>æ—¶åˆ»ç›‘å¬å¹¿æ’­</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>æœ‰åºå¹¿æ’­-Ordered Broadcast
    <ul>
      <li>æŒ‰ç…§Priorityå±æ€§å€¼ä»å¤§-å°æ’åº,Â Priorityå±æ€§ç›¸åŒè€…ï¼ŒåŠ¨æ€æ³¨å†Œçš„å¹¿æ’­ä¼˜å…ˆ</li>
      <li>å…ˆæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…å¯ä»¥å¯¹å¹¿æ’­è¿›è¡Œæˆªæ–­ï¼Œå³åæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…ä¸å†æ¥æ”¶åˆ°æ­¤å¹¿æ’­</li>
      <li>å…ˆæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…å¯ä»¥å¯¹å¹¿æ’­è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆåæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…å°†æ¥æ”¶åˆ°è¢«ä¿®æ”¹åçš„å¹¿æ’­</li>
    </ul>
  </li>
  <li>åº”ç”¨å†…å¹¿æ’­
    <ul>
      <li>å°†å…¨å±€å¹¿æ’­æ”¹ä¸ºå±€éƒ¨å¹¿æ’­
        <ul>
          <li>å°†exportedå±æ€§è®¾ç½®ä¸ºfalse</li>
          <li>åœ¨å¹¿æ’­å‘é€å’Œæ¥æ”¶æ—¶ï¼Œå¢è®¾ç›¸åº”æƒé™permissionï¼Œç”¨äºæƒé™éªŒè¯</li>
          <li>å‘é€å¹¿æ’­æ—¶æŒ‡å®šè¯¥å¹¿æ’­æ¥æ”¶å™¨æ‰€åœ¨çš„åŒ…å
            <ul>
              <li>é€šè¿‡<strong>intent.setPackage(packageName)</strong>æŒ‡å®šæŠ¥å</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>ä½¿ç”¨å°è£…å¥½çš„LocalBroadcastManagerç±»
        <ul>
          <li>å¯¹äºLocalBroadcastManageræ–¹å¼å‘é€çš„åº”ç”¨å†…å¹¿æ’­ï¼Œåªèƒ½é€šè¿‡LocalBroadcastManageråŠ¨æ€æ³¨å†Œï¼Œä¸èƒ½é™æ€æ³¨å†Œ</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="å‘é€å¹¿æ’­">å‘é€å¹¿æ’­</h3>
<ul>
  <li>Contextæä¾›çš„å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ç”¨äºå‘é€å¹¿æ’­ã€‚
    <ul>
      <li>1.sendBroadcast()ï¼šå‘é€Normal Broadcastã€‚</li>
      <li>2.sendOrderedBroadcast()ï¼šå‘é€Ordered Broadcastã€‚</li>
    </ul>
  </li>
  <li>Local</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>/**
* LocalBroadcast receiver used for inter-process communication which provides application security
* has it doesnâ€™t allow other process to communicate.
*/
Intent broadcastIntent = new Intent();
broadcastIntent.setAction(ServiceActivity.ResponseReceiver.LOCAL_ACTION);
broadcastIntent.putExtra(TEXT_OUTPUT, outputText);
LocalBroadcastManager localBroadcastManager = LocalBroadcastManager.getInstance(this);
localBroadcastManager.sendBroadcast(broadcastIntent);
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å†·å¯åŠ¨-vs-çƒ­å¯åŠ¨">å†·å¯åŠ¨ vs çƒ­å¯åŠ¨</h2>
<ul>
  <li>å†·å¯åŠ¨
    <ul>
      <li>åå°æ²¡æœ‰è¯¥åº”ç”¨çš„è¿›ç¨‹</li>
      <li>é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹
        <ul>
          <li>å…ˆåˆ›å»ºå’Œåˆå§‹åŒ–Applicationç±»</li>
          <li>å†åˆ›å»ºå’Œåˆå§‹åŒ–<code class="language-plaintext highlighter-rouge">MainActivity</code>ç±»ï¼ˆåŒ…æ‹¬ä¸€ç³»åˆ—çš„æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ï¼‰ï¼Œæœ€åæ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>çƒ­å¯åŠ¨
    <ul>
      <li>å½“åº”ç”¨å·²ç»è¢«æ‰“å¼€</li>
      <li>è¢«æŒ‰ä¸‹è¿”å›é”®ã€Homeé”®ç­‰æŒ‰é”®æ—¶å›åˆ°æ¡Œé¢æˆ–è€…æ˜¯å…¶ä»–ç¨‹åºè¦†ç›–</li>
      <li>çƒ­å¯åŠ¨çš„è¿‡ç¨‹åªéœ€è¦åˆ›å»ºå’Œåˆå§‹åŒ–ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">MainActivity</code>å°±è¡Œäº†ï¼Œè€Œä¸å¿…åˆ›å»ºå’Œåˆå§‹åŒ–<code class="language-plaintext highlighter-rouge">Application</code>
        <ul>
          <li>ç›´æ¥èµ°MainActivityï¼ˆåŒ…æ‹¬ä¸€ç³»åˆ—çš„æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ï¼‰</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="å†·å¯åŠ¨æµç¨‹">å†·å¯åŠ¨æµç¨‹</h2>

<h3 id="zygoteè¿›ç¨‹-å’Œ-systemserverè¿›ç¨‹">Zygoteè¿›ç¨‹ å’Œ SystemServerè¿›ç¨‹</h3>

<ul>
  <li>Zygoteè¿›ç¨‹
    <ul>
      <li>åº”ç”¨ç¨‹åºè¿›ç¨‹éƒ½æ˜¯ç”±Zygoteè¿›ç¨‹å­µåŒ–å‡ºæ¥çš„ï¼Œè€ŒZygoteè¿›ç¨‹æ˜¯ç”±Initè¿›ç¨‹å¯åŠ¨çš„</li>
      <li>Zygoteè¿›ç¨‹å¯åŠ¨
        <ul>
          <li>åˆ›å»ºä¸€ä¸ªDalvikè™šæ‹Ÿæœºå®ä¾‹</li>
          <li>åŠ è½½Javaè¿è¡Œæ—¶åº“</li>
          <li>æ³¨å†Œä¸€äº›Androidæ ¸å¿ƒç±»çš„JNIæ–¹æ³•æ¥å‰é¢åˆ›å»ºçš„Dalvikè™šæ‹Ÿæœºå®ä¾‹ä¸­å»</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>SystemServerè¿›ç¨‹
    <ul>
      <li>SystemServerçš„è¿›ç¨‹åå®é™…ä¸Šå«åšâ€œsystem_serverâ€</li>
      <li>ç³»ç»Ÿä¸­çš„æœåŠ¡é©»ç•™åœ¨å…¶ä¸­,å¸¸è§çš„æ¯”å¦‚WindowManagerServerï¼ˆWmsï¼‰ã€ActivityManagerSystemServiceï¼ˆAmSï¼‰ã€ PackageManagerServerï¼ˆPmSï¼‰ç­‰ï¼Œ
        <ul>
          <li>è¿™äº›ç³»ç»ŸæœåŠ¡éƒ½æ˜¯ä»¥ä¸€ä¸ªçº¿ç¨‹çš„æ–¹å¼å­˜åœ¨äºSystemServerè¿›ç¨‹ä¸­</li>
        </ul>
      </li>
      <li>SSæ˜¯ç”±Zygoteé€šè¿‡Zygote.forkSystemServerå‡½æ•°forkè¯ç”Ÿå‡ºæ¥çš„
        <ul>
          <li>init1()æ˜¯nativeå‡½æ•°,å¯åŠ¨äº† c++è¿è¡Œæ—¶åº“,å¦‚ï¼šsqllite,OpenGL ESç­‰,ç„¶åæŠŠè°ƒç”¨çº¿ç¨‹åŠ å…¥Binderé€šä¿¡ä¸­</li>
          <li>nit2åœ¨Javaå±‚,å°±æ˜¯å•ç‹¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹,ç”¨ä»¥å¯åŠ¨ç³»ç»Ÿå„é¡¹æœåŠ¡:Wms, Ams, Pmsç­‰</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="å¯åŠ¨æµç¨‹">å¯åŠ¨æµç¨‹</h3>

<p>Applicationæ„é€ æ–¹æ³• â€“&gt; <code class="language-plaintext highlighter-rouge">attachBaseContext()</code>â€“&gt;<code class="language-plaintext highlighter-rouge">onCreate</code> â€“&gt;Activityæ„é€ æ–¹æ³• â€“&gt; <code class="language-plaintext highlighter-rouge">onCreate()</code> â€“&gt; é…ç½®ä¸»ä½“ä¸­çš„èƒŒæ™¯ç­‰æ“ä½œ â€“&gt;<code class="language-plaintext highlighter-rouge">onStart()</code> â€“&gt; <code class="language-plaintext highlighter-rouge">onResume()</code> â€“&gt; æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶æ˜¾ç¤º</p>

<ul>
  <li>ç‚¹å‡»appå›¾æ ‡ï¼Œä»Zygoteè¿›ç¨‹forkåˆ›å»ºæ–°è¿›ç¨‹ç»™åº”ç”¨
    <ul>
      <li>ç‚¹å‡»æ¡Œé¢Appå›¾æ ‡ï¼ŒLauncherè¿›ç¨‹é‡‡ç”¨Binder IPCå‘system_serverè¿›ç¨‹å‘èµ·startActivityè¯·æ±‚</li>
      <li>system_serverè¿›ç¨‹æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå‘zygoteè¿›ç¨‹å‘é€åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚ï¼›</li>
      <li>Zygoteè¿›ç¨‹forkå‡ºæ–°çš„å­è¿›ç¨‹ï¼Œå³Appè¿›ç¨‹ï¼›</li>
    </ul>
  </li>
  <li>ä¾æ¬¡åˆ›å»ºå’Œåˆå§‹åŒ–Applicationç±»ã€åˆ›å»ºMainActivityç±»ã€åŠ è½½ä¸»é¢˜æ ·å¼Themeä¸­çš„windowBackgroundç­‰å±æ€§è®¾ç½®ç»™MainActivityä»¥åŠé…ç½®Activityå±‚çº§ä¸Šçš„ä¸€äº›å±æ€§
    <ul>
      <li>Appè¿›ç¨‹ï¼Œé€šè¿‡Binder IPCå‘sytem_serverè¿›ç¨‹å‘èµ·attachApplicationè¯·æ±‚ï¼›</li>
      <li>system_serverè¿›ç¨‹åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œè¿›è¡Œä¸€ç³»åˆ—å‡†å¤‡å·¥ä½œåï¼Œå†é€šè¿‡binder IPCå‘Appè¿›ç¨‹å‘é€scheduleLaunchActivityè¯·æ±‚</li>
      <li>Appè¿›ç¨‹çš„binderçº¿ç¨‹ï¼ˆApplicationThreadï¼‰åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡handlerå‘ä¸»çº¿ç¨‹å‘é€LAUNCH_ACTIVITYæ¶ˆæ¯</li>
      <li>ä¸»çº¿ç¨‹åœ¨æ”¶åˆ°Messageåï¼Œé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºç›®æ ‡Activityï¼Œå¹¶å›è°ƒActivity.onCreate()ç­‰æ–¹æ³•</li>
      <li>åˆ°æ­¤ï¼ŒAppä¾¿æ­£å¼å¯åŠ¨ï¼Œå¼€å§‹è¿›å…¥Activityç”Ÿå‘½å‘¨æœŸï¼Œæ‰§è¡Œå®ŒonCreate/onStart/onResumeæ–¹æ³•ï¼ŒUIæ¸²æŸ“ç»“æŸåä¾¿å¯ä»¥çœ‹åˆ°Appçš„ä¸»ç•Œé¢</li>
    </ul>
  </li>
</ul>

<h2 id="activityå¯åŠ¨æµç¨‹">Activityå¯åŠ¨æµç¨‹</h2>

<ul>
  <li>Activity1è°ƒç”¨startActivityï¼Œå®é™…ä¼šè°ƒç”¨Instrumentationç±»çš„execStartActivityæ–¹æ³•ï¼ŒInstrumentationæ˜¯ç³»ç»Ÿç”¨æ¥ç›‘æ§Activityè¿è¡Œçš„ä¸€ä¸ªç±»ï¼ŒActivityçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½æœ‰å®ƒçš„å½±å­</li>
  <li>é€šè¿‡è·¨è¿›ç¨‹çš„binderè°ƒç”¨ï¼Œè¿›å…¥åˆ°ActivityManagerServiceä¸­ï¼Œå…¶å†…éƒ¨ä¼šå¤„ç†Activityæ ˆï¼Œé€šçŸ¥Activity1 Pauseï¼ŒActivity1 æ‰§è¡ŒPause åå‘ŠçŸ¥AMS</li>
  <li>åœ¨ActivityManagerServiceä¸­çš„startProcessLockedä¸­è°ƒç”¨äº†Process.start()æ–¹æ³•ã€‚å¹¶é€šè¿‡è¿æ¥è°ƒç”¨Zygoteçš„nativeæ–¹æ³•forkAndSpecializeï¼Œæ‰§è¡Œforkä»»åŠ¡ã€‚ä¹‹åå†é€šè¿‡è·¨è¿›ç¨‹è°ƒç”¨è¿›å…¥åˆ°Activity2æ‰€åœ¨çš„<strong>è¿›ç¨‹</strong>ä¸­</li>
  <li>ApplicationThreadæ˜¯ä¸€ä¸ªbinderå¯¹è±¡ï¼Œå…¶è¿è¡Œåœ¨binderçº¿ç¨‹æ± ä¸­ï¼Œå†…éƒ¨åŒ…å«ä¸€ä¸ªHç±»ï¼Œè¯¥ç±»ç»§æ‰¿äºç±»Handlerã€‚ä¸»çº¿ç¨‹å‘èµ·bind Applicationï¼ŒAMS ä¼šåšä¸€äº›é…ç½®å·¥ä½œï¼Œç„¶åè®©ä¸»çº¿ç¨‹ bind ApplicationThreadï¼ŒApplicationThreadå°†å¯åŠ¨Activity2çš„ä¿¡æ¯é€šè¿‡Hå¯¹è±¡å‘é€ç»™<strong>ä¸»çº¿ç¨‹</strong>ã€‚å‘é€çš„æ¶ˆæ¯æ˜¯EXECUTE_TRANSACTIONï¼Œæ¶ˆæ¯ä½“æ˜¯ä¸€ä¸ª ClientTransactionï¼Œå³ LaunchActivityItemã€‚ä¸»çº¿ç¨‹æ‹¿åˆ°Activity2çš„ä¿¡æ¯åï¼Œè°ƒç”¨Instrumentationç±»çš„newActivityæ–¹æ³•ï¼Œå…¶å†…é€šè¿‡ClassLoaderåˆ›å»ºActivity2<strong>å®ä¾‹</strong></li>
  <li>é€šçŸ¥Activity2å»performCreate</li>
</ul>

<p>æ³¨ï¼šç°åœ¨å‘é€çš„éƒ½æ˜¯EXECUTE_TRANSACTION ï¼Œé€šè¿‡ TransactionExecutor æ¥æ‰§è¡Œ ClientTransaction, ClientTransaction ä¸­åŒ…å«å„ç§ ClientTransactionItemï¼Œå¦‚ PauseActivityItemã€LaunchActivityItemã€StopActivityItemã€ResumeActivityItemã€DestroyActivityItem ç­‰ï¼Œè¿™äº›Itemçš„executeæ–¹æ³•æ¥å¤„ç†ç›¸åº”çš„handleï¼Œå¦‚handlePauseActivityã€handleLaunchActivityç­‰ï¼Œé€šçŸ¥ç›¸åº”çš„Activityæ¥performã€‚</p>

<h2 id="serializable-java">Serializable-Java</h2>

<h3 id="cons">cons</h3>

<ul>
  <li>reflection - slow</li>
  <li>standard Java interface</li>
  <li>creates a lot of temporary objects and causes quite a bit of garbage collection</li>
</ul>

<h3 id="pros">pros</h3>

<ul>
  <li>easier to implement</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemSerializable</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">address</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ItemSerializable</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getAddress</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">address</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">address</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="parcelable">Parcelable</h2>
<h3 id="cons-1">cons</h3>

<ul>
  <li>takes more time to implement</li>
</ul>

<h3 id="pros-1">pros</h3>

<ul>
  <li>faster</li>
  <li>array can be passed via Intent in android</li>
  <li>no reflection, é€‰æ‹©å­—æ®µè¯»å†™</li>
  <li>kotlinæœ‰æ³¨è§£</li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">@Parcelize</span>
<span class="kd">data class</span> <span class="nc">Item</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">title</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">price</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">imageUrl</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">category</span><span class="p">:</span> <span class="nc">Category</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">Parcelable</span>

<span class="nd">@Parcelize</span>
<span class="kd">data class</span> <span class="nc">Category</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">tag</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">Parcelable</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>javaç¼–å†™ç¨å¾®å¤æ‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemParcelable</span> <span class="kd">implements</span> <span class="nc">Parcelable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">address</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ItemParcelable</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">ItemParcelable</span><span class="o">(</span><span class="nc">Parcel</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">createStringArrayList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">describeContents</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeToParcel</span><span class="o">(</span><span class="nc">Parcel</span> <span class="n">dest</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">dest</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">age</span><span class="o">);</span>
        <span class="n">dest</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">dest</span><span class="o">.</span><span class="na">writeStringList</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getAddress</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">address</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">address</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Creator</span><span class="o">&lt;</span><span class="nc">ItemParcelable</span><span class="o">&gt;</span> <span class="no">CREATOR</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Creator</span><span class="o">&lt;</span><span class="nc">ItemParcelable</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">ItemParcelable</span><span class="o">[]</span> <span class="nf">newArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">ItemParcelable</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">ItemParcelable</span> <span class="nf">createFromParcel</span><span class="o">(</span><span class="nc">Parcel</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ItemParcelable</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="construct">construct</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
<span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(),</span> <span class="n">clazz</span><span class="o">);</span>
<span class="nc">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Item</span><span class="o">(</span><span class="s">"hello"</span><span class="o">,</span> <span class="mi">888</span><span class="o">,</span> <span class="s">"testing"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Category</span><span class="o">(</span><span class="s">"tag"</span><span class="o">));</span>
<span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"primitive Int"</span><span class="o">,</span> <span class="mi">888</span><span class="o">);</span>
<span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"item"</span><span class="o">,</span><span class="n">item</span><span class="o">);</span>

<span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">arrayList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"dddddddd"</span><span class="o">);</span>

<span class="nc">ItemParcelable</span> <span class="n">mObjects</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ItemParcelable</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="mi">99</span><span class="o">,</span> <span class="n">arrayList</span><span class="o">);</span>
<span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"itemParcelable"</span><span class="o">,</span><span class="n">mObjects</span><span class="o">);</span>

<span class="nc">ItemSerializable</span> <span class="n">itemSerializable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ItemSerializable</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="mi">99</span><span class="o">,</span> <span class="n">arrayList</span><span class="o">);</span>
<span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"itemSerializable"</span><span class="o">,</span> <span class="n">itemSerializable</span><span class="o">);</span>

<span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="getdata">getdata</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>        <span class="kd">val</span> <span class="py">item</span> <span class="p">=</span> <span class="n">intent</span><span class="p">.</span><span class="n">getParcelableExtra</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;(</span><span class="s">"item"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">java</span> <span class="p">=</span> <span class="n">intent</span><span class="p">.</span><span class="n">getParcelableExtra</span><span class="p">&lt;</span><span class="nc">ItemParcelable</span><span class="p">&gt;(</span><span class="s">"itemParcelable"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">itemSerializable</span> <span class="p">=</span> <span class="n">intent</span><span class="p">.</span><span class="nf">getSerializableExtra</span><span class="p">(</span><span class="s">"itemSerializable"</span><span class="p">)</span> <span class="k">as</span> <span class="nc">ItemSerializable</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="view-structure">View: structure</h2>
<p><img src="../images/activity_view.png" alt="image.png" /></p>

<ul>
  <li>DecorViewæ˜¯ä¸€ä¸ªåº”ç”¨çª—å£çš„æ ¹å®¹å™¨ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªFrameLayout</li>
  <li>DecorViewæœ‰å”¯ä¸€ä¸€ä¸ªå­Viewï¼Œå®ƒæ˜¯ä¸€ä¸ªå‚ç›´LinearLayoutï¼ŒåŒ…å«ä¸¤ä¸ªå­å…ƒç´ ï¼Œ
    <ul>
      <li>ä¸€ä¸ªæ˜¯TitleViewï¼ˆActionBarçš„å®¹å™¨ï¼‰ï¼Œ</li>
      <li>å¦ä¸€ä¸ªæ˜¯ContentViewï¼ˆçª—å£å†…å®¹çš„å®¹å™¨ï¼‰</li>
    </ul>
  </li>
</ul>

<h2 id="activitysetcontentview">Activity.setContentView</h2>
<p>è¿™ä¸ªæ–¹æ³•åªæ˜¯å®Œæˆäº†Activityçš„ContentViewçš„åˆ›å»ºï¼Œè€Œå¹¶æ²¡æœ‰æ‰§è¡ŒViewçš„ç»˜åˆ¶æµç¨‹ã€‚</p>

<ul>
  <li>å®é™…ä¸Šè°ƒç”¨åˆ°äº†PhoneWindowçš„setContentView()æ–¹æ³•ã€‚</li>
  <li>PhoneWindowçš„setContentView()æ–¹æ³•ä¸­
    <ul>
      <li>è°ƒç”¨äº†LayoutInflaterçš„inflate()æ–¹æ³•æ¥å¡«å……å¸ƒå±€</li>
      <li>ä¼ å…¥äº†decorViewä½œä¸ºLayoutInflater.inflate()çš„rootå‚æ•°</li>
      <li>æœ€ç»ˆè°ƒç”¨çš„æ˜¯inflate(XmlPullParser, ViewGroup, boolean)æ–¹æ³•æ¥å¡«å……å¸ƒå±€
        <ul>
          <li>å•ç‹¬å¤„ç†mergeæ ‡ç­¾</li>
          <li>è°ƒç”¨rInflate()æ–¹æ³•æ¥é€’å½’å¡«å……å¸ƒå±€
            <ul>
              <li>inflate()å’ŒrInflate()æ–¹æ³•ä¸­éƒ½è°ƒç”¨äº†rInflateChildren()æ–¹æ³•</li>
              <li>rInflateChildren()æ–¹æ³•å®é™…ä¸Šè°ƒç”¨äº†rInflate()æ–¹æ³•</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="view-inflateæ–¹æ³•æ€»ç»“">View: inflateæ–¹æ³•æ€»ç»“</h2>

<ul>
  <li>XMLä¸­ä¿å­˜äº†ViewTreeçš„ç»“æ„å’ŒViewçš„ç›¸å…³æ ‡ç­¾ä¿¡æ¯ï¼ˆåŒ…æ‹¬Viewçš„ç±»å‹å’Œä¸€äº›å±æ€§å€¼ï¼‰
    <ul>
      <li>è¿™äº›ä¿¡æ¯ä¼šåœ¨åé¢é€šè¿‡åå°„çš„æ–¹å¼ï¼ˆå¦‚æœæ²¡æœ‰Factory2å’ŒFactoryçš„è¯ï¼‰åˆ›å»ºå®ä¾‹å¯¹è±¡
        <ul>
          <li>å¦‚æœåˆ›å»ºçš„æ˜¯ViewGroupï¼Œåˆ™ä¼šå¯¹å®ƒçš„å­Viewéå†é‡å¤åˆ›å»ºæ­¥éª¤</li>
          <li>åˆ›å»ºå®ŒViewå¯¹è±¡åï¼Œä¼šaddåˆ°å¯¹åº”çš„ViewGroupä¸­</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>inflate-&gt;rInflate-&gt;createViewFromTag-&gt;createView</li>
</ul>

<h2 id="view-viewç»˜åˆ¶çš„èµ·ç‚¹">View: viewç»˜åˆ¶çš„èµ·ç‚¹</h2>

<ul>
  <li>Viewçš„ç»˜åˆ¶æ˜¯ç”±ViewRootæ¥è´Ÿè´£çš„ã€‚æ¯ä¸ªåº”ç”¨ç¨‹åºçª—å£çš„decorViewéƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„ViewRootå¯¹è±¡ï¼Œè¿™ç§å…³è”å…³ç³»æ˜¯ç”±WindowManageræ¥ç»´æŠ¤çš„ã€‚</li>
  <li>å½“å»ºç«‹å¥½äº†decorViewä¸ViewRootçš„å…³è”åï¼ŒViewRootç±»çš„requestLayout()æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä»¥å®Œæˆåº”ç”¨ç¨‹åºç”¨æˆ·ç•Œé¢çš„åˆæ¬¡å¸ƒå±€ã€‚å®é™…è¢«è°ƒç”¨çš„æ˜¯ViewRootImplç±»çš„requestLayout()æ–¹æ³•
    <ul>
      <li>setContentView() åªæ˜¯æŠŠ View æ·»åŠ åˆ° DecorView ä¸Š</li>
      <li>onResume() ä¸­ ViewRootImpl å’Œ DecorView åšäº†å…³è”</li>
      <li>requestLayout() å’Œ invalidate() ä¼šè§¦å‘ ViewRootImpl ç»˜åˆ¶ View</li>
      <li>åœ¨ Activity çš„ onResume() æ–¹æ³•æ‰§è¡Œåï¼ŒDecorView ä¼šè¢«æ·»åŠ å¸¦ ViewRootImpl ä¸­ã€‚ç„¶åæ‰§è¡Œ requestlayout()
```java
//H:Handler-&gt;handleMessage(RESUME_ACTIVITY)-&gt;handleResumeActivity-&gt;windowmanager.addView
public void addView(View view, ViewGroup.LayoutParams params,
   Display display, Window parentWindow) {
  â€¦â€¦</li>
    </ul>

    <p>ViewRootImpl root;
  View panelParentView = null;</p>

    <p>synchronized (mLock) {
      â€¦â€¦
      root = new ViewRootImpl(view.getContext(), display);</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  view.setLayoutParams(wparams);

  mViews.add(view);
  mRoots.add(root);
  mParams.add(wparams);   }
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>// do this last because it fires off messages to start doing things
  try {
      root.setView(view, wparams, panelParentView); //invoke requestLayout
  } â€¦â€¦
}
```</p>
  </li>
</ul>

<h2 id="view-measurespec">View: MeasureSpec</h2>
<blockquote>
  <p>exactlyä¼˜å…ˆï¼Œat_mostæ¬¡ä¹‹</p>
</blockquote>

<p>MeasureSpecä»£è¡¨ä¸€ä¸ª32ä½intå€¼ï¼Œ</p>

<ul>
  <li>é«˜2ä½ä»£è¡¨SpecModeï¼ŒSpecModeæ˜¯æŒ‡æµ‹é‡æ¨¡å¼ï¼Œ
    <ul>
      <li>UNSPECIFIED, æŒ‡çˆ¶å®¹å™¨ä¸å¯¹viewæœ‰ä»»ä½•é™åˆ¶ï¼Œè¦å¤šå¤§ç»™å¤šå¤§ï¼Œä¸€èˆ¬ç”¨äºç³»ç»Ÿå†…éƒ¨ï¼Œè¡¨ç¤ºæµ‹é‡çš„çŠ¶æ€</li>
      <li>EXACTLY, çˆ¶å®¹å™¨æ£€æµ‹å‡ºviewéœ€è¦çš„ç²¾ç¡®å¤§å°ï¼Œviewçš„æœ€ç»ˆå¤§å°å°±æ˜¯SpecSizeçš„å¤§å°ã€‚å¯¹åº”LayoutParamsä¸­çš„match_parentæ¨¡å¼</li>
      <li>AT_MOST,çˆ¶å®¹å™¨æŒ‡å®šäº†ä¸€ä¸ªSpecSize, viewçš„å¤§å°ä¸èƒ½å¤§äºè¿™ä¸ªå€¼, å¯¹åº”LayoutParams.wrap_contentæ¨¡å¼</li>
    </ul>
  </li>
  <li>ä½30ä½ä»£è¡¨SpecSizeï¼Œè€ŒSpecSizeæ˜¯æŒ‡åœ¨æŸç§æµ‹é‡æ¨¡å¼ä¸‹çš„è§„æ ¼å¤§å°</li>
  <li>MeasureSpec ä¸æ˜¯ å”¯ä¸€ ç”± LayoutParams å†³å®š çš„ï¼Œ LayoutParams éœ€ è¦å’Œ çˆ¶ å®¹å™¨ ä¸€èµ· æ‰èƒ½ å†³å®š View çš„ MeasureSpecï¼Œ ä»è€Œ è¿›ä¸€æ­¥ å†³å®š View çš„ å®½/ é«˜
    <ul>
      <li>if(viewå›ºå®šå®½/é«˜)â€“ ä¸å—çˆ¶å®¹å™¨ï¼ŒViewçš„MeasureSpec==EXACTLYï¼Œå¹¶ä¸”å¤§å°éµå¾ªLayoutParamsä¸­çš„å¤§å°</li>
      <li>if(viewå®½/é«˜æ˜¯match_parent)
        <ul>
          <li>if çˆ¶å®¹å™¨æ˜¯EXACTLY, view=EXACTLYï¼Œå¤§å°æ˜¯çˆ¶ç±»çš„å‰©ä½™ç©ºé—´</li>
          <li>if çˆ¶å®¹å™¨æ˜¯AT_MOSTï¼Œview=AT_MOSTï¼Œä¸èƒ½è¶…è¿‡çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´</li>
        </ul>
      </li>
      <li>if(viewå®½/é«˜æ˜¯wrap_content),ä¸å—çˆ¶å®¹å™¨å½±å“ï¼Œview=AT_MOSTï¼Œä¸èƒ½è¶…è¿‡çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´
        <blockquote>

          <p>UNSPECIFIED-ä¸»è¦ ç”¨äº ç³»ç»Ÿ å†…éƒ¨ å¤šæ¬¡ Measure çš„ æƒ…å½¢ï¼Œ ä¸€èˆ¬æ¥è¯´ï¼Œ æˆ‘ä»¬ ä¸éœ€è¦ å…³æ³¨ æ­¤ æ¨¡å¼ã€‚</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>å¯¹äºDecorViewï¼Œå…¶MeasureSpecç”±çª—å£çš„å°ºå¯¸å’Œå…¶è‡ªèº«çš„LayoutParamsæ¥å…±åŒç¡®å®š</li>
  <li>å¯¹äºæ™®é€šViewï¼Œå…¶MeasureSpecç”±çˆ¶å®¹å™¨çš„MeasureSpecå’Œè‡ªèº«çš„LayoutParamsæ¥å…±åŒå†³å®šï¼ŒMeasureSpecä¸€æ—¦ç¡®å®šåï¼ŒonMeasureä¸­å°±å¯ä»¥ç¡®å®šViewçš„æµ‹é‡å®½/é«˜</li>
</ul>

<h2 id="view-ä¸‰é˜¶æ®µ">View: ä¸‰é˜¶æ®µ</h2>
<p><img src="../images/view_three_phase.png" alt="image.png" /></p>

<h2 id="view-è·å–å®½é«˜çš„æ—¶æœº">View: è·å–å®½é«˜çš„æ—¶æœº</h2>
<blockquote>
  <p>åœ¨onCreateã€onStartã€onResumeä¸­å‡æ— æ³•æ­£ç¡®å¾—åˆ°æŸä¸ªViewçš„å®½/é«˜ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºViewçš„measureè¿‡ç¨‹å’ŒActivityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œå› æ­¤æ— æ³•ä¿è¯Activityæ‰§è¡Œäº†onCreateã€onStartã€onResumeæ—¶æŸä¸ªViewå·²ç»æµ‹é‡å®Œæ¯•äº†ï¼Œå¦‚æœViewè¿˜æ²¡æœ‰æµ‹é‡å®Œæ¯•ï¼Œé‚£ä¹ˆè·å¾—çš„å®½/é«˜å°±æ˜¯0</p>
</blockquote>

<ul>
  <li>Activity/ View# onWindowFocusChanged,Â </li>
  <li>view. post( runnable),Â </li>
  <li>ViewTreeObserver,Â </li>
  <li>view. measure( int widthMeasureSpec, int heightMeasureSpec), æ ¹æ® View çš„ LayoutParams æ¥ åˆ†æƒ…å†µï¼Œæ˜¯å¦æœ‰æ•ˆ
    <ul>
      <li>match_parent, ç›´æ¥æ”¾å¼ƒï¼Œæ— æ•ˆ</li>
      <li>å…·ä½“æ•°å€¼(dp/px)â€“ok</li>
      <li>wrap_contentâ€“ok</li>
    </ul>
  </li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">object</span> <span class="nc">ViewUtil</span> <span class="p">{</span>

    <span class="cm">/**
     * viewçš„layoutparamsæŒ‡å®šäº†å®½é«˜ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è·å–çœŸå®å®½é«˜, è­¬å¦‚100px
     */</span>
    <span class="k">fun</span> <span class="nf">measureViewOfExactly</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="nc">View</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">widthMeasureSpec</span> <span class="p">=</span> <span class="nc">View</span><span class="p">.</span><span class="nc">MeasureSpec</span><span class="p">.</span><span class="nf">makeMeasureSpec</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nc">EXACTLY</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">heightMeasureSpec</span> <span class="p">=</span> <span class="nc">View</span><span class="p">.</span><span class="nc">MeasureSpec</span><span class="p">.</span><span class="nf">makeMeasureSpec</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nc">View</span><span class="p">.</span><span class="nc">MeasureSpec</span><span class="p">.</span><span class="nc">EXACTLY</span><span class="p">)</span>
        <span class="n">view</span><span class="p">.</span><span class="nf">measure</span><span class="p">(</span><span class="n">widthMeasureSpec</span><span class="p">,</span> <span class="n">heightMeasureSpec</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="cm">/**
     * viewçš„layoutparamsæ˜¯wrap_contentï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è·å–çœŸå®å®½é«˜
     */</span>
    <span class="k">fun</span> <span class="nf">measureViewOfWrapContent</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="nc">View</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">widthMeasureSpec</span> <span class="p">=</span> <span class="nc">View</span><span class="p">.</span><span class="nc">MeasureSpec</span><span class="p">.</span><span class="nf">makeMeasureSpec</span><span class="p">((</span><span class="mi">1</span> <span class="n">shl</span> <span class="mi">30</span><span class="p">)</span> <span class="p">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nc">AT_MOST</span><span class="p">)</span>
        <span class="c1">//viewçš„ å°ºå¯¸ ä½¿ç”¨ 30 ä½ äºŒè¿›åˆ¶ è¡¨ç¤ºï¼Œ ä¹Ÿå°±æ˜¯è¯´ æœ€å¤§ æ˜¯ 30 ä¸ª 1ï¼ˆ å³ 2^ 30 - 1ï¼‰ï¼Œ ä¹Ÿå°±æ˜¯( 1 &lt;&lt; 30) - 1ï¼Œ åœ¨æœ€ å¤§åŒ– æ¨¡å¼ ä¸‹ï¼Œ æˆ‘ä»¬ ç”¨ View ç†è®ºä¸Š èƒ½ æ”¯æŒ çš„ æœ€å¤§å€¼ å» æ„é€  MeasureSpec æ˜¯ åˆç† çš„ã€‚</span>
        <span class="kd">val</span> <span class="py">heightMeasureSpec</span> <span class="p">=</span> <span class="nc">View</span><span class="p">.</span><span class="nc">MeasureSpec</span><span class="p">.</span><span class="nf">makeMeasureSpec</span><span class="p">((</span><span class="mi">1</span> <span class="n">shl</span>  <span class="mi">30</span><span class="p">)</span> <span class="p">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nc">AT_MOST</span><span class="p">)</span>
        <span class="n">view</span><span class="p">.</span><span class="nf">measure</span><span class="p">(</span><span class="n">widthMeasureSpec</span><span class="p">,</span> <span class="n">heightMeasureSpec</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>é”™è¯¯ç”¨æ³•å…³äº View çš„ measureï¼Œ ç½‘ç»œ ä¸Šæœ‰ ä¸¤ä¸ª é”™è¯¯ çš„ ç”¨æ³•ã€‚ ä¸ºä»€ä¹ˆ è¯´æ˜¯ é”™è¯¯ çš„ï¼Œ é¦–å…ˆ å…¶ è¿èƒŒ äº† ç³»ç»Ÿ çš„ å†…éƒ¨ å®ç° è§„èŒƒï¼ˆ å› ä¸º æ— æ³• é€šè¿‡ é”™è¯¯ çš„ MeasureSpec å» å¾—å‡º åˆæ³• çš„ SpecModeï¼Œ ä»è€Œ å¯¼è‡´ measure è¿‡ç¨‹ å‡ºé”™ï¼‰ï¼Œ å…¶æ¬¡ ä¸èƒ½ ä¿è¯ ä¸€ å®šèƒ½ measure å‡º æ­£ç¡® çš„ ç»“æœã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">//ç¬¬ä¸€ ç§ é”™è¯¯ ç”¨æ³•ï¼š </span>
<span class="kt">int</span> <span class="n">widthMeasureSpec</span> <span class="o">=</span> <span class="nc">MeasureSpec</span><span class="o">.</span> <span class="nf">makeMeasureSpec</span><span class="o">(-</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">MeasureSpec</span><span class="o">.</span> <span class="no">UNSPECIFIED</span><span class="o">);</span> 
<span class="kt">int</span> <span class="n">heightMeasureSpec</span> <span class="o">=</span> <span class="nc">MeasureSpec</span><span class="o">.</span> <span class="nf">makeMeasureSpec</span><span class="o">(-</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">MeasureSpec</span><span class="o">.</span> <span class="no">UNSPECIFIED</span><span class="o">);</span> 
<span class="n">view</span><span class="o">.</span> <span class="nf">measure</span><span class="o">(</span> <span class="n">widthMeasureSpec</span><span class="o">,</span> <span class="n">heightMeasureSpec</span><span class="o">);</span> 

<span class="c1">//ç¬¬äºŒ ç§ é”™è¯¯ ç”¨æ³•ï¼š </span>
<span class="n">view</span><span class="o">.</span> <span class="nf">measure</span><span class="o">(</span> <span class="nc">LayoutParams</span><span class="o">.</span> <span class="no">WRAP_</span> <span class="no">CONTENT</span><span class="o">,</span> <span class="nc">LayoutParams</span><span class="o">.</span> <span class="no">WRAP_</span> <span class="no">CONTENT</span><span class="o">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="viewçš„æµ‹é‡å®½é«˜å’Œæœ€ç»ˆå®½é«˜æœ‰ä»€ä¹ˆåŒºåˆ«">Viewçš„æµ‹é‡å®½/é«˜å’Œæœ€ç»ˆå®½/é«˜æœ‰ä»€ä¹ˆåŒºåˆ«</h3>
<p>åœ¨Viewçš„é»˜è®¤å®ç°ä¸­ï¼ŒViewçš„æµ‹é‡å®½/é«˜å’Œæœ€ç»ˆå®½/é«˜æ˜¯ç›¸ç­‰çš„ï¼Œåªä¸è¿‡æµ‹é‡å®½/é«˜å½¢æˆäºViewçš„measureè¿‡ç¨‹ï¼Œè€Œæœ€ç»ˆå®½/é«˜å½¢æˆäºViewçš„layoutè¿‡ç¨‹ï¼Œå³ä¸¤è€…çš„èµ‹å€¼æ—¶æœºä¸åŒï¼Œæµ‹é‡å®½/é«˜çš„èµ‹å€¼æ—¶æœºç¨å¾®æ—©ä¸€äº›ã€‚å› æ­¤ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºViewçš„æµ‹é‡å®½/é«˜å°±ç­‰äºæœ€ç»ˆå®½/é«˜ï¼Œä½†æ˜¯çš„ç¡®å­˜åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¼šå¯¼è‡´ä¸¤è€…ä¸ä¸€è‡´</p>

<h2 id="view-layout">View: layout</h2>

<ul>
  <li>å½“ViewGroupçš„ä½ç½®è¢«ç¡®å®šåï¼Œå®ƒåœ¨onLayoutä¸­ä¼šéå†æ‰€æœ‰çš„å­å…ƒç´ å¹¶è°ƒç”¨å…¶layoutæ–¹æ³•ï¼Œåœ¨layoutæ–¹æ³•ä¸­onLayoutæ–¹æ³•åˆä¼šè¢«è°ƒç”¨ã€‚</li>
  <li>layoutæ–¹æ³•ç¡®å®šViewæœ¬èº«çš„ä½ç½®ï¼Œè€ŒonLayoutæ–¹æ³•åˆ™ä¼šç¡®å®šæ‰€æœ‰å­å…ƒç´ çš„ä½ç½®ï¼Œ</li>
</ul>

<h2 id="view-draw">View: draw</h2>

<ul>
  <li>viewçš„ç»˜åˆ¶è¿‡ç¨‹
    <ul>
      <li>ç»˜åˆ¶ èƒŒæ™¯ background. draw( canvas)</li>
      <li>ç»˜åˆ¶ è‡ªå·±ï¼ˆ onDrawï¼‰</li>
      <li>ç»˜åˆ¶ childrenï¼ˆ dispatchDrawï¼‰</li>
      <li>ç»˜åˆ¶ è£…é¥°ï¼ˆ onDrawScrollBarsï¼‰</li>
    </ul>
  </li>
  <li>invalidate(),Â è¯·æ±‚é‡ç»˜ View æ ‘ï¼Œå³ draw è¿‡ç¨‹ï¼Œå‡å¦‚è§†å›¾å‘ç”Ÿå¤§å°æ²¡æœ‰å˜åŒ–å°±ä¸ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">layout()</code>è¿‡ç¨‹ï¼Œå¹¶ä¸”åªç»˜åˆ¶é‚£äº›è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">invalidate()</code>æ–¹æ³•çš„ View</li>
  <li>requestLayout(),Â å½“å¸ƒå±€å˜åŒ–çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–¹å‘å˜åŒ–ï¼Œå°ºå¯¸çš„å˜åŒ–ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåœ¨è‡ªå®šä¹‰çš„è§†å›¾ä¸­ï¼Œå¦‚æœæŸäº›æƒ…å†µä¸‹å¸Œæœ›é‡æ–°æµ‹é‡å°ºå¯¸å¤§å°ï¼Œåº”è¯¥æ‰‹åŠ¨å»è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå®ƒä¼šè§¦å‘<code class="language-plaintext highlighter-rouge">measure()</code>å’Œ<code class="language-plaintext highlighter-rouge">layout()</code>è¿‡ç¨‹ï¼Œä½†ä¸ä¼šè¿›è¡Œ drawã€‚</li>
</ul>

<h2 id="touch-eventç‚¹å‡»äº‹ä»¶çš„ä¼ é€’è§„åˆ™">touch event:ç‚¹å‡»äº‹ä»¶çš„ä¼ é€’è§„åˆ™</h2>

<ul>
  <li>public boolean dispatchTouchEvent( MotionEvent ev) â€“ è¿›è¡Œäº‹ä»¶çš„åˆ†å‘</li>
  <li>public boolean onInterceptTouchEvent( MotionEvent event) â€“ æ˜¯å¦æ‹¦æˆªäº‹ä»¶</li>
  <li>public boolean onTouchEvent( MotionEvent event) â€“ å¤„ç†ç‚¹å‡»äº‹ä»¶</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">dispatchTouchEvent</span><span class="o">(</span> <span class="nc">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span> 
    <span class="kt">boolean</span> <span class="n">consume</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> 
    <span class="k">if</span> <span class="o">(</span><span class="n">onInterceptTouchEvent</span><span class="o">(</span> <span class="n">ev</span><span class="o">))</span> <span class="o">{</span> 
        <span class="n">consume</span> <span class="o">=</span> <span class="n">onTouchEvent</span><span class="o">(</span> <span class="n">ev</span><span class="o">);</span> 
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> 
        <span class="n">consume</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span> <span class="nf">dispatchTouchEvent</span><span class="o">(</span> <span class="n">ev</span><span class="o">);</span> 
    <span class="o">}</span> 
    <span class="k">return</span> <span class="n">consume</span><span class="o">;</span> 
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>ViewGroup
    <ul>
      <li>onIntercepTouchEventè¿”å›trueï¼Œæ‹¦æˆªå½“å‰äº‹ä»¶ï¼Œäº‹ä»¶ä¼šäº¤ç»™è¯¥ViewGroupå¤„ç†</li>
      <li>onIntercepTouchEventè¿”å›falseï¼Œä¸æ‹¦æˆªå½“å‰äº‹ä»¶ï¼Œäº‹ä»¶ä¼šä¼ é€’ç»™å­å…ƒç´ å¤„ç†ï¼Œå­å…ƒç´ çš„dispatchTouchEventæ–¹æ³•ä¼šè¢«è°ƒç”¨</li>
    </ul>
  </li>
  <li>View
    <ul>
      <li>è®¾ç½®äº†onTouchListenerï¼Œ onTouchListenerä¼˜å…ˆçº§æ¯”onTouchEventè¦é«˜
        <ul>
          <li>onTouchListenerçš„onTouchè¿”å›trueï¼Œ viewçš„onTouchEventä¸ä¼šè¢«è°ƒç”¨</li>
          <li>onTouchListenerçš„onTouchè¿”å›falseï¼Œ viewçš„onTouchEventä¼šè¢«è°ƒç”¨</li>
        </ul>
      </li>
      <li>æ²¡æœ‰è®¾ç½®onTouchListenerï¼Œåˆ™è°ƒç”¨onTouchEvent</li>
      <li>å¦‚æœè®¾ç½®äº†onClickListenerï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å…¶onClickæ–¹æ³•â€“OnClickListenerä¼˜å…ˆçº§æœ€ä½ï¼Œå¤„äºäº‹ä»¶çš„æœ«ç«¯</li>
    </ul>
  </li>
  <li>ä¼ é€’è¿‡ç¨‹ï¼šActivity-&gt;Window-&gt;Viewã€‚é¡¶çº§viewæ”¶åˆ°äº‹ä»¶åä¼šæŒ‰ç…§äº‹ä»¶åˆ†å‘æœºåˆ¶åˆ†å‘äº‹ä»¶
    <ul>
      <li>å¦‚æœä¸€ä¸ªViewçš„onTouchEventè¿”å›falseï¼Œé‚£ä¹ˆçˆ¶å®¹å™¨çš„onTouchEventå°†ä¼šè¢«è°ƒç”¨</li>
    </ul>
  </li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>  <span class="c1">//é‡å†™çˆ¶ç±»çš„onTouchEvent </span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nc">MotionEvent</span><span class="p">?):</span> <span class="nc">Boolean</span> <span class="p">{</span>

        <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"testing"</span><span class="p">,</span> <span class="s">"just testing"</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">onTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="p">}</span>
  
  <span class="c1">//setOnTouchListener</span>
      <span class="k">fun</span> <span class="nf">setOnTouchEventListenerTest</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">setOnTouchListener</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">OnTouchListener</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onTouch</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nc">View</span><span class="p">?,</span> <span class="n">event</span><span class="p">:</span> <span class="nc">MotionEvent</span><span class="p">?):</span> <span class="nc">Boolean</span> <span class="p">{</span>
                <span class="c1">//do something</span>

                <span class="c1">//å¦‚æœè¿”å›trueï¼Œ viewçš„onTouchEvent å°±ä¸ä¼šè¢«è°ƒç”¨ï¼Œ</span>
                <span class="c1">//å¯è§ OnTouchListener çš„ ä¼˜å…ˆçº§ é«˜äº onTouchEventï¼Œ è¿™æ ·åšçš„å¥½å¤„æ˜¯æ–¹ä¾¿åœ¨å¤–ç•Œå¤„ç†ç‚¹å‡» äº‹ä»¶ã€‚</span>
                <span class="k">return</span> <span class="k">false</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="touch-eventæ€»ç»“11æ¡">touch event:æ€»ç»“11æ¡</h2>

<ul>
  <li>åŒä¸€ä¸ªäº‹ä»¶åºåˆ—æ˜¯æŒ‡ä»æ‰‹æŒ‡æ¥è§¦å±å¹•çš„é‚£ä¸€åˆ»èµ·ï¼Œåˆ°æ‰‹æŒ‡ç¦»å¼€å±å¹•çš„é‚£ä¸€åˆ»ç»“æŸï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶åºåˆ—ä»¥downäº‹ä»¶å¼€å§‹ï¼Œä¸­é—´å«æœ‰æ•°é‡ä¸å®šçš„moveäº‹ä»¶ï¼Œæœ€ç»ˆä»¥upäº‹ä»¶ç»“æŸã€‚</li>
  <li>æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªäº‹ä»¶åºåˆ—åªèƒ½è¢«ä¸€ä¸ªViewæ‹¦æˆªä¸”æ¶ˆè€—ã€‚å› ä¸ºä¸€æ—¦ä¸€ä¸ªå…ƒç´ æ‹¦æˆªäº†æŸæ­¤äº‹ä»¶ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªäº‹ä»¶åºåˆ—å†…çš„æ‰€æœ‰äº‹ä»¶éƒ½ä¼šç›´æ¥äº¤ç»™å®ƒå¤„ç†ï¼Œå› æ­¤åŒä¸€ä¸ªäº‹ä»¶åºåˆ—ä¸­çš„äº‹ä»¶ä¸èƒ½åˆ†åˆ«ç”±ä¸¤ä¸ªViewåŒæ—¶å¤„ç†ï¼Œä½†æ˜¯é€šè¿‡ç‰¹æ®Šæ‰‹æ®µå¯ä»¥åšåˆ°ï¼Œæ¯”å¦‚ä¸€ä¸ªViewå°†æœ¬è¯¥è‡ªå·±å¤„ç†çš„äº‹ä»¶é€šè¿‡onTouchEventå¼ºè¡Œä¼ é€’ç»™å…¶ä»–Viewå¤„ç†ã€‚</li>
  <li>æŸä¸ªViewä¸€æ—¦å†³å®šæ‹¦æˆªï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ªäº‹ä»¶åºåˆ—éƒ½åªèƒ½ç”±å®ƒæ¥å¤„ç†ï¼ˆå¦‚æœäº‹ä»¶åºåˆ—èƒ½å¤Ÿä¼ é€’ç»™å®ƒçš„è¯ï¼‰ï¼Œå¹¶ä¸”å®ƒçš„onInterceptTouchEventä¸ä¼šå†è¢«è°ƒç”¨ã€‚</li>
  <li>æŸä¸ªViewä¸€æ—¦å¼€å§‹å¤„ç†äº‹ä»¶ï¼Œå¦‚æœå®ƒä¸æ¶ˆè€—ACTION_DOWNäº‹ä»¶ï¼ˆonTouchEventè¿”å›äº†falseï¼‰ï¼Œé‚£ä¹ˆåŒä¸€äº‹ä»¶åºåˆ—ä¸­çš„å…¶ä»–äº‹ä»¶éƒ½ä¸ä¼šå†äº¤ç»™å®ƒæ¥å¤„ç†ï¼Œå¹¶ä¸”äº‹ä»¶å°†é‡æ–°äº¤ç”±å®ƒçš„çˆ¶å…ƒç´ å»å¤„ç†ï¼Œå³çˆ¶å…ƒç´ çš„onTouchEventä¼šè¢«è°ƒç”¨ã€‚æ„æ€å°±æ˜¯äº‹ä»¶ä¸€æ—¦äº¤ç»™ä¸€ä¸ªViewå¤„ç†ï¼Œé‚£ä¹ˆå®ƒå°±å¿…é¡»æ¶ˆè€—æ‰ï¼Œå¦åˆ™åŒä¸€äº‹ä»¶åºåˆ—ä¸­å‰©ä¸‹çš„äº‹ä»¶å°±ä¸å†äº¤ç»™å®ƒæ¥å¤„ç†äº†ï¼Œè¿™å°±å¥½æ¯”ä¸Šçº§äº¤ç»™ç¨‹åºå‘˜ä¸€ä»¶äº‹ï¼Œå¦‚æœè¿™ä»¶äº‹æ²¡æœ‰å¤„ç†å¥½ï¼ŒçŸ­æœŸå†…ä¸Šçº§å°±ä¸æ•¢å†æŠŠäº‹æƒ…äº¤ç»™è¿™ä¸ªç¨‹åºå‘˜åšäº†ï¼ŒäºŒè€…æ˜¯ç±»ä¼¼çš„é“ç†ã€‚</li>
  <li>å¦‚æœViewä¸æ¶ˆè€—é™¤ACTION_DOWNä»¥å¤–çš„å…¶ä»–äº‹ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªç‚¹å‡»äº‹ä»¶ä¼šæ¶ˆå¤±ï¼Œæ­¤æ—¶çˆ¶å…ƒç´ çš„onTouchEventå¹¶ä¸ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”å½“å‰Viewå¯ä»¥æŒç»­æ”¶åˆ°åç»­çš„äº‹ä»¶ï¼Œæœ€ç»ˆè¿™äº›æ¶ˆå¤±çš„ç‚¹å‡»äº‹ä»¶ä¼šä¼ é€’ç»™Activityå¤„ç†ã€‚</li>
  <li>ViewGroupé»˜è®¤ä¸æ‹¦æˆªä»»ä½•äº‹ä»¶ã€‚Androidæºç ä¸­ViewGroupçš„onInterceptTouch-Eventæ–¹æ³•é»˜è®¤è¿”å›falseã€‚</li>
  <li>Viewæ²¡æœ‰onInterceptTouchEventæ–¹æ³•ï¼Œä¸€æ—¦æœ‰ç‚¹å‡»äº‹ä»¶ä¼ é€’ç»™å®ƒï¼Œé‚£ä¹ˆå®ƒçš„onTouchEventæ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚</li>
  <li>Viewçš„onTouchEventé»˜è®¤éƒ½ä¼šæ¶ˆè€—äº‹ä»¶ï¼ˆè¿”å›trueï¼‰ï¼Œé™¤éå®ƒæ˜¯ä¸å¯ç‚¹å‡»çš„ï¼ˆclickableå’ŒlongClickableåŒæ—¶ä¸ºfalseï¼‰ã€‚Viewçš„longClickableå±æ€§é»˜è®¤éƒ½ä¸ºfalseï¼Œclickableå±æ€§è¦åˆ†æƒ…å†µï¼Œæ¯”å¦‚Buttonçš„clickableå±æ€§é»˜è®¤ä¸ºtrueï¼Œè€ŒTextViewçš„clickableå±æ€§é»˜è®¤ä¸ºfalseã€‚</li>
  <li>Viewçš„enableå±æ€§ä¸å½±å“onTouchEventçš„é»˜è®¤è¿”å›å€¼ã€‚å“ªæ€•ä¸€ä¸ªViewæ˜¯disableçŠ¶æ€çš„ï¼Œåªè¦å®ƒçš„clickableæˆ–è€…longClickableæœ‰ä¸€ä¸ªä¸ºtrueï¼Œé‚£ä¹ˆå®ƒçš„onTouchEventå°±è¿”å›trueã€‚</li>
  <li>onClickä¼šå‘ç”Ÿçš„å‰ææ˜¯å½“å‰Viewæ˜¯å¯ç‚¹å‡»çš„ï¼Œå¹¶ä¸”å®ƒæ”¶åˆ°äº†downå’Œupçš„äº‹ä»¶ã€‚</li>
  <li>äº‹ä»¶ä¼ é€’è¿‡ç¨‹æ˜¯ç”±å¤–å‘å†…çš„ï¼Œå³äº‹ä»¶æ€»æ˜¯å…ˆä¼ é€’ç»™çˆ¶å…ƒç´ ï¼Œç„¶åå†ç”±çˆ¶å…ƒç´ åˆ†å‘ç»™å­Viewï¼Œé€šè¿‡requestDisallowInterceptTouchEventæ–¹æ³•å¯ä»¥åœ¨å­å…ƒç´ ä¸­å¹²é¢„çˆ¶å…ƒç´ çš„äº‹ä»¶åˆ†å‘è¿‡ç¨‹ï¼Œä½†æ˜¯ACTION_DOWNäº‹ä»¶é™¤å¤–</li>
</ul>

<h2 id="touch-eventaction_canceläº‹ä»¶">touch event:ACTION_CANCELäº‹ä»¶</h2>

<ul>
  <li>å¦‚æœä¸Šå±‚viewgroupæ‹¦æˆªäº†äº‹ä»¶ï¼Œdownäº‹ä»¶è¿˜æ˜¯ä¼šå‘åˆ°viewï¼Œè¿™æ ·å­viewå°±æœ‰æœºä¼šrequestDisallowInterceptTouchEvent</li>
  <li>å¦‚æœæ²¡æœ‰requestDisallowInterceptTouchEventï¼Œåªå‘cancelç»™viewï¼Œåç»­çš„move/upäº‹ä»¶ä¸ä¼šå†å‘ç»™view
```java
/**</li>
  <li>Tries to claim the userâ€™s drag motion, and requests disallowing any</li>
  <li>ancestors from stealing events in the drag.
 */
private void attemptClaimDrag() {
 //mParent = getParent();
 if (mParent != null) {
     mParent.requestDisallowInterceptTouchEvent(true);
 }
}</li>
</ul>

<p>@Override
public boolean onTouchEvent(MotionEvent event) {
    if (event.getAction() == MotionEvent.ACTION_DOWN) {
        if (iWantToKeepThisEventForMyself(event)) {
            attemptClaimDrag();
        }
        //your logic here
    } else {
        //your logic here
    }
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
</pre></td><td class="rouge-code"><pre>

## touch event: å®šä¹‰
- Each user touch event is wrapped up as a MotionEvent
- Describes user's current action:
   - ACTION_DOWN
   - ACTION_UP
   - ACTION_MOVE
   - ACTION_POINTER_DOWN
   - ACTION_POINTER_UP
   - ACTION_CANCEL
- Event metadaa included
   - touch location
   - number of pointers
   - event time
- A "gesture" is defined as beginning with ACTION_DOWN and ending with ACTION_UP



## touch event: äº‹ä»¶ä¼ é€’


- envent starts at the activity with dispatchTouchEvent()
- Events flow top down through views
   - Parents(ViewGroup) dispatch events to their children
   - Can intercept events at any time
- Events flow down the chain (and back up) until consumed
   - Views must declare interest by consuming ACTION_DOWN
   - Further events not delivered for efficiency
- Any unconsumed events end at Activity with onTouchEvent()
- Optional External OnToucherListener can intercept touches on any View/ViewGroup



## touch event: View


- Activity.dispatchTouchEvent()
   - Always first to be called
   - Sends events to root view attached to Window
   - onTouchEvent()
      - called if no views consume the event
      - always last to be called
- View.dispatchTouchEvent()
   - Sends envent to listener first, if exist
      - View.OnTouchListener.onTouch()
   - If not consumed processes the touch itself
      - View.onTouchEvent()



## touch event: ViewGroup


- ViewGroup.dispatchTouchEvent()
   - onInterceptTouchEvent()
      - check if it should s supersede children
      - Passes ACTION_CANCEL to active child
      - return true once consumes all subsequent events
   - For each child view, in reverse order they were added
      - if touch is relevant(inside view), child.dispatchTouchEvent()
      - if not handled by previous , dispatch to next view
   - if no children handle event, listener gets a chance
      - OnTouchListener.onTouch()
   - if no listener, or not handled
      - onTouchEvent()



![](../images/touch_event_ignorant.jpeg)


![](../images/touch_event_interested.jpeg)


![](../images/touch_event_intercept.png)

## touch event:custom touch handling

### Custom Touch Handling


- return true with ACTION_DOWN to show interest, even if you aren't interested in ACTION_DOWN , return true;
- for other events, returning true simply stops further processing
- Call through to super whenever possible
- Don't intercept events until you're ready to take them all
- always handle ACTION_CANCEL



### multi-touch handling


- MotionEvent.getPointerCount() - How many pointers are currently on the screen
- Use MotionEvent methods that take a pointer index parameter to get data for a specific pointer



### System Touch Handlers


- don't jump right to custom touch handling if you don't have to...
- simple use:
   - OnClickListener
   - OnLongClickListener
   - OnTouchListener
   - OnScrollListener/View.onScrollChanged()
- complex use GestureDetector:
   - onDown(), onSingleTapUp(), onDoubleTap()
   - onLongPress()
   - onScroll()
   - onFling()
- complex use ScaleGestureDetector:
   - onScaleBegin()
   - onScale()
   - onScaleEnd()


## Activity Launch Mode
### standard
&gt; ç¼ºçœæ¨¡å¼



## Activity Launch Mode: singleTop
&gt; single on Topï¼Œ å¦‚æœåœ¨æ ˆé¡¶å°±ä¸æ–°åˆ›å»ºäº†

å¦‚æ–°åˆ›å»ºä¸€ä¸ªactivity Dä¸ºä¾‹

- ä¸ç®¡æ ˆä¸­æœ‰æ²¡æœ‰Dï¼Œæ ˆé¡¶æ²¡æœ‰Då°±æ–°åˆ›å»ºä¸€ä¸ªD
- å¦‚æœæ ˆä¸­æœ‰Dï¼Œ å°±è°ƒç”¨è¯¥Dçš„onNewIntent() ï¼Œ ä¸å†æ–°åˆ›å»º
- ä¸€ä¸ªstackå¯èƒ½æœ‰è¯¥activityçš„å¤šä¸ªå®ä¾‹(è¯¥activityåœ¨æ ˆé¡¶ååˆæœ‰åˆ«çš„activityè¿›æ ˆ)
#### singleTopé€‚åˆæ¥æ”¶é€šçŸ¥å¯åŠ¨çš„å†…å®¹æ˜¾ç¤ºé¡µé¢ã€‚

- ä¾‹å¦‚ï¼ŒæŸä¸ªæ–°é—»å®¢æˆ·ç«¯çš„æ–°é—»å†…å®¹é¡µé¢ï¼Œå¦‚æœæ”¶åˆ°10ä¸ªæ–°é—»æ¨é€ï¼Œæ¯æ¬¡éƒ½æ‰“å¼€ä¸€ä¸ªæ–°é—»å†…å®¹é¡µé¢æ˜¯å¾ˆçƒ¦äººçš„ï¼Œç”¨æˆ·åœ¨ç‚¹å‡»è¿”å›æŒ‰é”®çš„æ—¶å€™ä¹Ÿä¼šå¯¼è‡´è§†è§‰å·®å¼‚ã€‚
- ç™»å½•é¡µé¢ã€WXPayEntryActivityã€WXEntryActivity ã€æ¨é€é€šçŸ¥æ 







## Activity Launch Mode:singleTask
&gt; single in task

å›é€€æ ˆä¸­æ²¡æœ‰è¯¥ç±»å‹çš„Activityï¼Œåˆ›å»ºActivityï¼Œå¦åˆ™ï¼ŒonNewIntent+ClearTopã€‚


- å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå…ˆåœ¨ç³»ç»Ÿä¸­æŸ¥æ‰¾å±æ€§å€¼affinityç­‰äºå®ƒçš„å±æ€§å€¼taskAffinityçš„Taskå­˜åœ¨
- æ³¨æ„ä¼šClearTop
- ä»–çš„ä¸Šé¢å¯ä»¥æœ‰å…¶ä»–çš„Activityã€‚è¿™ç‚¹ä¸singleInstanceæ˜¯æœ‰åŒºåˆ«çš„ã€‚
#### singleTaské€‚åˆä½œä¸ºç¨‹åºå…¥å£ç‚¹ã€‚

- ä¾‹å¦‚æµè§ˆå™¨çš„ä¸»ç•Œé¢ã€‚ä¸ç®¡ä»å¤šå°‘ä¸ªåº”ç”¨å¯åŠ¨æµè§ˆå™¨ï¼Œåªä¼šå¯åŠ¨ä¸»ç•Œé¢ä¸€æ¬¡ï¼Œå…¶ä½™æƒ…å†µéƒ½ä¼šèµ°onNewIntentï¼Œå¹¶ä¸”ä¼šæ¸…ç©ºä¸»ç•Œé¢ä¸Šé¢çš„å…¶ä»–é¡µé¢ã€‚
- WebViewé¡µé¢ã€æ‰«ä¸€æ‰«é¡µé¢ã€ç”µå•†ä¸­ï¼šè´­ç‰©ç•Œé¢ï¼Œç¡®è®¤è®¢å•ç•Œé¢ï¼Œä»˜æ¬¾ç•Œé¢





## Activity Launch Mode: singleInstance

singleInstanceï¼Œå›é€€æ ˆä¸­ï¼Œåªæœ‰è¿™ä¸€ä¸ªActivityï¼Œæ²¡æœ‰å…¶ä»–Activityã€‚


#### singleInstanceåº”ç”¨åœºæ™¯ï¼š

- é—¹é“ƒçš„å“é“ƒç•Œé¢ã€‚è¿”å›å°±æ˜¯ç”¨æˆ·ä¸Šä¸€ä¸ªåº”ç”¨çš„ç•Œé¢ï¼Œè€Œä¸æ˜¯é—¹é’Ÿçš„task æ ˆçš„activity
- æ­¤å¯åŠ¨æ¨¡å¼å’Œæˆ‘ä»¬ä½¿ç”¨çš„æµè§ˆå™¨å·¥ä½œåŸç†ç±»ä¼¼ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“åœ¨å¤šä¸ªç¨‹åºä¸­è®¿é—®æµè§ˆå™¨æ—¶ï¼Œå¦‚æœå½“å‰æµè§ˆå™¨æ²¡æœ‰æ‰“å¼€ï¼Œåˆ™æ‰“å¼€æµè§ˆå™¨ï¼Œå¦åˆ™ä¼šåœ¨å½“å‰æ‰“å¼€çš„æµè§ˆå™¨ä¸­è®¿é—®
- ç³»ç»ŸLauncherã€é”å±é”®ã€æ¥ç”µæ˜¾ç¤ºç­‰ç³»ç»Ÿåº”ç”¨



## AndroidåŠ¨ç”»
- ViewåŠ¨ç”»
- å¸§åŠ¨ç”»
- å±æ€§åŠ¨ç”»



## AndroidåŠ¨ç”»: ViewåŠ¨ç”»
#### ç®€æ˜“çš„åŠ¨ç”»æ•ˆæœ

- ä»…ä»…æ˜¯åŠ¨çš„ View çš„ç»˜åˆ¶åœ°æ–¹ï¼ŒView çœŸæ­£çš„ä½ç½®å¹¶æ²¡æœ‰ä¸€èµ·åŠ¨ç”»
- ä¸€èˆ¬ä¼šç”¨ä½œç›´æ¥ä½œç”¨é¡µé¢ä¸­çš„ View ä¸Šï¼Œå®ç°åŸºæœ¬çš„åŠ¨ç”»æ•ˆæœï¼šå¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ã€é€æ˜åº¦ã€æˆ–å‰å‡ è€…çš„äº¤é›†
   - å¹³ç§»åŠ¨ç”»-TranslateAnimation
   - ç¼©æ”¾åŠ¨ç”»-ScaleAnimation
   - æ—‹è½¬åŠ¨ç”»-RotateAnimation
   - é€æ˜åº¦åŠ¨ç”»-AlphaAnimation

#### è‡ªå®šä¹‰ViewåŠ¨ç”»
è‡ªå®šä¹‰ViewåŠ¨ç”»æ˜¯æ•°å­¦ä¸­çŸ©é˜µå˜æ¢çš„ç»†èŠ‚, åªéœ€è¦çŸ¥é“è‡ªå®šä¹‰Viewçš„æ–¹æ³•å¹¶ä¸”åœ¨éœ€è¦çš„æ—¶å€™å‚è€ƒçŸ©é˜µå˜æ¢çš„ç»†èŠ‚å°±å¯ä»¥å†™å‡ºç‰¹å®šçš„è‡ªå®šä¹‰åŠ¨ç”»

- é›†æˆAnimationæŠ½è±¡ç±»
- é‡å†™initializeæ–¹æ³•ï¼Œ åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ
- é‡å†™applyTransformationæ–¹æ³•ï¼Œè¿›è¡Œç›¸å¯¹åº”çš„çŸ©é˜µå˜æ¢

#### ViewåŠ¨ç”»çš„ç‰¹æ®Šä½¿ç”¨åœºæ™¯

- ViewGroupä¸­æ§åˆ¶å­å…ƒç´ çš„å‡ºåœºæ•ˆæœ
   - ä¸ºå­å…ƒç´ å®šä¹‰å…¥åœºåŠ¨ç”»-res/anim/anim_item.xml
```xml
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;set xmlns:android="http://schemas.android.com/apk/res/android"
    android:duration="300"
    android:interpolator="@android:anim/accelerate_interpolator"
    android:shareInterpolator="true"&gt;
    &lt;alpha
        android:fromAlpha="0.0"
        android:toAlpha="1.0" /&gt;
    &lt;translate
        android:fromXDelta="500"
        android:toXDelta="0.0"/&gt;
&lt;/set&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å®šä¹‰LayoutAnimation,-res/anim/anim_layout.xml.Â  Â ä¹Ÿæ˜¯viewåŠ¨ç”»ï¼Œä¸ºViewGroupçš„å­å…ƒç´ åŠ ä¸Šå‡ºåœºæ•ˆæœ
```xml
&lt;?xml version=â€1.0â€ encoding=â€utf-8â€?&gt;</li>
</ul>
<layoutAnimation xmlns:android="http://schemas.android.com/apk/res/android" android:delay="0.5" android:animationOrder="normal" android:animation="@anim/anim_item">
</layoutAnimation>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
   - ä¸ºViewGroupæ¥æŒ‡å®šandroid:layoutAnimationå±æ€§

```xml
&lt;ListView
    //........      
    android: layoutAnimation="@ anim/ anim_ layout"
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>Activityå®ç°ä¸åŒActivityä¹‹é—´çš„åˆ‡æ¢æ•ˆæœï¼Œ è°ƒç”¨overridePendingTransition(**int **enterAnim, **int **exitAnim)
    <ul>
      <li>enterAnim-Activityè¢«æ‰“å¼€æ—¶ï¼Œæ‰€éœ€çš„åŠ¨ç”»èµ„æºid</li>
      <li>exitAnim-Activityè¢«æš‚åœæ—¶ï¼Œæ‰€éœ€çš„åŠ¨ç”»èµ„æºid</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">//å¯åŠ¨Activity        </span>
<span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">TestActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
<span class="n">overridePendingTransition</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">anim</span><span class="o">.</span><span class="na">enter_</span> <span class="n">anim</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">anim</span><span class="o">.</span><span class="na">exit_</span> <span class="n">anim</span><span class="o">);</span>

<span class="c1">//é€€å‡ºActivity</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">finish</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
        <span class="n">overridePendingTransition</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">anim</span><span class="o">.</span><span class="na">enter_</span> <span class="n">anim</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">anim</span><span class="o">.</span><span class="na">exit_</span> <span class="n">anim</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>Fragmentæ·»åŠ åˆ‡æ¢åŠ¨ç”», é€šè¿‡FragmentTransactionçš„setCustomAnimations</li>
</ul>

<h2 id="androidåŠ¨ç”»-å¸§åŠ¨ç”»">AndroidåŠ¨ç”»: å¸§åŠ¨ç”»</h2>
<p>å°±å’Œçœ‹çš„åŠ¨ç”»ç‰‡ä¸€æ ·ï¼Œæ¯ä¸€å¸§ä»£è¡¨ä¸€ä¸ªç”»é¢åŠ¨ä½œï¼Œå½“å¿«é€Ÿé€å¸§æ˜¾ç¤ºæ—¶ï¼Œé€Ÿåº¦åˆ°è¾¾äººçœ¼æ— æ³•åˆ†è¾¨æ¯ä¸€å¸§æ—¶ï¼Œå°±è¾¾åˆ°äº†åŠ¨ç”»çš„æ•ˆæœã€‚ä½¿ç”¨åœºæ™¯ï¼Œåœ¨å¼€å‘ä¸­ä½¿ç”¨çš„çœŸæ˜¯å°‘ä¹‹åˆå°‘ï¼š</p>

<ul>
  <li>è®¾å¤‡çš„å¼€å…³æœºåŠ¨ç”»</li>
  <li>â€œå¤æ‚â€ çš„åŠ¨ç”»æ•ˆæœï¼Œçœ‹ä¼¼ä¸å¯èƒ½å®Œæˆçš„åŠ¨ç”»
    <blockquote>
      <p>å…¶å®çœŸæ­£ç”¨åˆ°å¸§åŠ¨ç”»æ—¶ï¼Œæ›´å¤šçš„æ—¶å€™æˆ‘ä»¬è¿˜ä¸å¦‚ä½¿ç”¨ GIF å›¾ç‰‡ä»£æ›¿ï¼Œç°åœ¨å‡ ä¸ªä¸»æµå›¾ç‰‡åŠ è½½æ¡†æ¶éƒ½æ”¯æŒ GIF å›¾ç‰‡ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ§åˆ¶ GIF çš„æ’­æ”¾æ—¶æœºã€‚</p>
    </blockquote>
  </li>
</ul>

<h4 id="å¸§åŠ¨ç”»ä½¿ç”¨">å¸§åŠ¨ç”»ä½¿ç”¨</h4>

<ul>
  <li>é€šè¿‡xmlæ¥å®šä¹‰AnimationDrawable</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;animation-list</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span> <span class="na">android:oneshot=</span><span class="s">"false"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">"@drawable/account"</span> <span class="na">android:duration=</span><span class="s">"500"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">"@drawable/account_2x"</span> <span class="na">android:duration=</span><span class="s">"500"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">"@drawable/account_3x"</span> <span class="na">android:duration=</span><span class="s">"500"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/animation-list&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å°†ä¸Šè¿°Drawableä½œä¸ºViewçš„èƒŒæ™¯ï¼Œå¹¶ä¸”é€šè¿‡Drawableæ¥æ’­æ”¾åŠ¨ç”»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>        <span class="nc">Button</span> <span class="n">mButton</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Button</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">button1</span><span class="o">);</span>
        <span class="n">mButton</span><span class="o">.</span><span class="na">setBackgroundResource</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">frame_</span> <span class="n">animation</span><span class="o">);</span>
        <span class="nc">AnimationDrawable</span> <span class="n">drawable</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AnimationDrawable</span><span class="o">)</span> <span class="n">mButton</span><span class="o">.</span><span class="na">getBackground</span><span class="o">();</span>
        <span class="n">drawable</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="androidåŠ¨ç”»-å±æ€§åŠ¨ç”»">AndroidåŠ¨ç”»: å±æ€§åŠ¨ç”»</h2>
<h4 id="åŸç†">åŸç†</h4>
<p>å±æ€§åŠ¨ç”»è¦æ±‚åŠ¨ç”»ä½œç”¨çš„å¯¹è±¡æä¾›è¯¥å±æ€§çš„getå’Œsetæ–¹æ³•ï¼Œå±æ€§åŠ¨ç”»æ ¹æ®å¤–æ¥ä¼ é€’çš„è¯¥å±æ€§çš„åˆå§‹å€¼å’Œæœ€ç»ˆå€¼ï¼Œä»¥åŠ¨ç”»çš„æ•ˆæœå¤šæ¬¡å»è°ƒç”¨setæ–¹æ³•ï¼Œæ¯æ¬¡ä¼ é€’ç»™setæ–¹æ³•çš„å€¼éƒ½ä¸ä¸€æ ·ï¼Œç¡®åˆ‡æ¥è¯´æ˜¯éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ‰€ä¼ é€’çš„å€¼è¶Šæ¥è¶Šæ¥è¿‘æœ€ç»ˆå€¼ã€‚å¯¹objectçš„å±æ€§abcåšåŠ¨ç”»ï¼Œè¦è®©åŠ¨ç”»ç”Ÿæ•ˆï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶</p>

<ul>
  <li>objectæä¾›å±æ€§çš„æ–¹æ³•
    <ul>
      <li>setAbcæ–¹æ³•</li>
      <li>getAbcæ–¹æ³•â€“å¦‚æœåŠ¨ç”»æ²¡æœ‰ä¼ é€’åˆå§‹å€¼ï¼Œå› ä¸ºç³»ç»Ÿè¦è·å–å±æ€§çš„åˆå§‹å€¼ï¼Œå¦åˆ™ä¼šcrash</li>
    </ul>
  </li>
  <li>objectçš„å±æ€§æ”¹å˜å¿…é¡»èƒ½å¤Ÿé€šè¿‡æŸç§æ–¹å¼åæ˜ å‡ºæ¥ï¼Œ è­¬å¦‚UIçš„æ”¹å˜ä¹‹ç±»ï¼Œå¦åˆ™å°±æ˜¯åŠ¨ç”»æ— æ•ˆæœäº†</li>
</ul>

<p>å¦åˆ™</p>

<ul>
  <li>ç»™å¯¹è±¡åŠ ä¸Šgetå’Œsetæ–¹æ³•â€“å‰ææ˜¯æœ‰æƒé™</li>
  <li>ç”¨ä¸€ä¸ªç±»æ¥åŒ…è£…åŸå§‹å¯¹è±¡ï¼Œé—´æ¥ä¸ºå…¶æä¾›getå’Œsetæ–¹æ³•</li>
  <li>ä½¿ç”¨ValueAnimatorï¼Œç›‘å¬åŠ¨ç”»è¿‡ç¨‹ï¼Œè‡ªå·±å®ç°å±æ€§æ”¹å˜</li>
</ul>

<h4 id="viewåŠ¨ç”»-vs-å±æ€§åŠ¨ç”»">viewåŠ¨ç”» vs å±æ€§åŠ¨ç”»</h4>

<ul>
  <li>View åŠ¨ç”»åªèƒ½ä¸º View æ·»åŠ åŠ¨ç”»æ•ˆæœï¼Œä¸”ä¸èƒ½ç›‘å¬ View ç›¸å…³å±æ€§çš„å˜åŒ–è¿‡ç¨‹ã€‚</li>
  <li>View åŠ¨ç”»æä¾›çš„åŠ¨ç”»èƒ½åŠ›è¾ƒä¸ºå•ä¸€ï¼Œç›®å‰åªæ”¯æŒå¸§åŠ¨ç”»ã€ç¼©æ”¾åŠ¨ç”»ã€ä½ç§»åŠ¨ç”»ã€æ—‹è½¬åŠ¨ç”»ã€é€æ˜åº¦åŠ¨ç”»ä»¥åŠè¿™äº›åŠ¨ç”»çš„é›†åˆåŠ¨ç”»ã€‚</li>
  <li>ViewåŠ¨ç”»æ”¹å˜çš„æ˜¯ View çš„ç»˜åˆ¶æ•ˆæœï¼ŒView çš„çœŸæ­£ä½ç½®å’Œç›¸å…³å±æ€§å¹¶ä¸ä¼šæ”¹å˜ï¼Œè¿™ä¹Ÿå°±é€ æˆäº†ç‚¹å‡»äº‹ä»¶çš„è§¦å‘åŒºåŸŸæ˜¯åŠ¨ç”»å‰çš„ä½ç½®è€Œä¸æ˜¯åŠ¨ç”»åçš„ä½ç½®çš„åŸå› ã€‚</li>
</ul>

<h4 id="å±æ€§åŠ¨ç”»">å±æ€§åŠ¨ç”»</h4>

<ul>
  <li>å±æ€§åŠ¨ç”»ä½œç”¨å¯¹è±¡ä¸å±€é™åœ¨ View ä¸Šï¼Œè€Œæ˜¯ä»»ä½•æä¾›äº† Getter å’Œ Setter æ–¹æ³•çš„å¯¹è±¡çš„å±æ€§ä¸Šã€‚</li>
  <li>å±æ€§åŠ¨ç”»æ²¡æœ‰ç›´æ¥æ”¹å˜ View çŠ¶æ€çš„èƒ½åŠ›ï¼Œè€Œæ˜¯é€šè¿‡åŠ¨æ€æ”¹å˜ View ç›¸å…³å±æ€§çš„æ–¹å¼æ¥æ”¹å˜ View çš„æ˜¾ç¤ºæ•ˆæœã€‚</li>
  <li>å±æ€§åŠ¨ç”»ä½¿ç”¨æ›´æ–¹ä¾¿ï¼Œå¯ä»¥ç”¨æ›´ç®€æ´çš„ä»£ç å®ç°ç›¸å…³çš„åŠ¨ç”»æ•ˆæœã€‚</li>
  <li>å±æ€§åŠ¨ç”»ä¸Šæ‰‹éš¾åº¦è¾ƒé«˜ï¼Œå¯¹äº propertyName éœ€è¦è‡ªå·±å»æŒ–æ˜ï¼Œæˆ–è€…è‡ªå·±é€šè¿‡ Wrapper çš„æ–¹å¼å»è‡ªå®šä¹‰ propertyNameã€‚</li>
  <li>å±æ€§åŠ¨ç”»æ˜¯ Android3.0 ä»¥ä¸Šç³»ç»Ÿæä¾›çš„èƒ½åŠ›ï¼Œåœ¨ 3.0 ä»¥ä¸‹éœ€å¯¼å…¥ nineoldandroids ä¸‰æ–¹åº“è§£å†³å…¼å®¹æ€§é—®é¢˜ã€‚</li>
</ul>

<h3 id="ä½¿ç”¨åŠ¨ç”»æ³¨æ„äº‹é¡¹">ä½¿ç”¨åŠ¨ç”»æ³¨æ„äº‹é¡¹</h3>

<ul>
  <li>OOMâ€“å¸§åŠ¨ç”»å›¾ç‰‡æ•°é‡å¤šæˆ–è€…è¾ƒå¤§çš„æ—¶å€™å®¹æ˜“å‡ºç°OOM</li>
  <li>å†…å­˜æ³„éœ²
    <ul>
      <li>å±æ€§åŠ¨ç”»æœ‰ä¸€ç±»æ— é™å¾ªç¯çš„åŠ¨ç”»ï¼Œ éœ€è¦åœ¨Activityé€€å‡ºçš„æ—¶å€™åŠæ—¶åœæ­¢å¦åˆ™ä¼šå†…å­˜æ³„éœ²</li>
      <li>ViewåŠ¨ç”»ä¸å­˜åœ¨è¯¥é—®é¢˜</li>
    </ul>
  </li>
  <li>è¿›è¡ŒåŠ¨ç”»å°½é‡ä½¿ç”¨dpï¼Œå› ä¸ºpxä¼šåœ¨ä¸åŒè®¾å¤‡ä¸Šæœ‰ä¸åŒçš„æ•ˆæœ</li>
  <li>ç¡¬ä»¶åŠ é€Ÿ-å¼€å¯ç¡¬ä»¶åŠ é€Ÿä¼šæé«˜åŠ¨ç”»æµç•…æ€§</li>
</ul>

<h2 id="handler">handler</h2>

<p>å‚è€ƒï¼š
<a href="https://my.oschina.net/u/3863980/blog/1933086">handler&amp;&amp;epoll</a>
<a href="https://blog.csdn.net/qingtiantianqing/article/details/72783952">https://blog.csdn.net/qingtiantianqing/article/details/72783952</a>
<a href="https://www.jianshu.com/p/44b322dfc040">https://www.jianshu.com/p/44b322dfc040</a></p>

<h2 id="handlerlooper">Handler:looper</h2>

<ul>
  <li>æ¯ä¸ªçº¿ç¨‹æœ‰ä¸”æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªLooperå¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªThreadLocal</li>
  <li>Looperå†…éƒ¨æœ‰ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œloop()æ–¹æ³•è°ƒç”¨åçº¿ç¨‹å¼€å§‹ä¸æ–­ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯æ‰§è¡Œ
    <ul>
      <li>æ¶ˆæ¯åˆ—è¡¨é‡‡ç”¨å•é“¾è¡¨ç»“æ„</li>
    </ul>
  </li>
  <li>Looperä½¿ä¸€ä¸ªçº¿ç¨‹å˜æˆLooperçº¿ç¨‹ã€‚</li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">HandlerActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_handler</span><span class="p">)</span>

        <span class="nc">Thread</span><span class="p">(</span><span class="nc">SampleTask</span><span class="p">(</span><span class="nc">MyHandler</span><span class="p">())).</span><span class="nf">start</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">updateTextView</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">textView3</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">value</span>
    <span class="p">}</span>

    <span class="k">inner</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="p">:</span> <span class="nc">Handler</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">handleMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nc">Message</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nf">getString</span><span class="p">(</span><span class="s">"message"</span><span class="p">)</span>
            <span class="nf">updateTextView</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>prepareMainLooperæ–¹æ³•ç»™ä¸»çº¿ç¨‹åˆ›å»ºlooperï¼Œä¹Ÿæä¾›äº†getMainLooperæ–¹æ³•æ¥è·å–ä¸»çº¿ç¨‹çš„Looper</li>
  <li>Looperæä¾›äº†ä¸¤ç§æ–¹æ³•é€€å‡º
    <ul>
      <li>quitâ€“ä¼šç›´æ¥é€€å‡ºLooper</li>
      <li>quitSafelyâ€“åªæ˜¯è®¾å®šä¸€ä¸ªé€€å‡ºæ ‡å¿—ï¼ŒæŠŠæ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢çš„å·²æœ‰æ¶ˆæ¯å¤„ç†å®Œæ¯•åæ‰å®‰å…¨é€€å‡º</li>
      <li>åœ¨å­çº¿ç¨‹å¦‚æœæ‰‹åŠ¨åˆ›å»ºäº†Looperï¼Œäº‹æƒ…å®Œæˆä¹‹ååº”è¯¥è°ƒç”¨quitæ–¹æ³•ç»ˆæ­¢æ¶ˆæ¯å¾ªç¯
        <ul>
          <li>ä¸é€€å‡ºï¼Œè¯¥å­çº¿ç¨‹ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€</li>
          <li>é€€å‡ºåçº¿ç¨‹ä¼šç«‹å³ç»ˆæ­¢</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Looperæœ€é‡è¦çš„æ–¹æ³•æ˜¯loopæ–¹æ³•ï¼Œåªæœ‰è°ƒç”¨äº†loopæ–¹æ³•ä¹‹åæ¶ˆæ¯å¾ªç¯ç³»ç»Ÿæ‰ä¼šçœŸæ­£èµ·ä½œç”¨
    <ul>
      <li>loopæ–¹æ³•ä¼šè°ƒç”¨MessageQueueçš„nextæ–¹æ³•æ¥è·å–æ–°æ¶ˆæ¯ï¼Œè€Œnextæ˜¯ä¸€ä¸ªé˜»å¡æ“ä½œï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œnextæ–¹æ³•ä¼šä¸€ç›´é˜»å¡åœ¨é‚£é‡Œï¼Œè¿™ä¹Ÿå¯¼è‡´loopæ–¹æ³•ä¸€ç›´é˜»å¡åœ¨é‚£é‡Œ</li>
      <li>å¦‚æœMessageQueueçš„nextæ–¹æ³•è¿”å›äº†æ–°æ¶ˆæ¯ï¼ŒLooperå°±ä¼šå¤„ç†è¿™æ¡æ¶ˆæ¯</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">loop</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//...</span>
        <span class="kd">final</span> <span class="nc">Looper</span> <span class="n">me</span> <span class="o">=</span> <span class="n">myLooper</span><span class="o">();</span>
        <span class="kd">final</span> <span class="nc">MessageQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="na">mQueue</span><span class="o">;</span>
        <span class="c1">//..</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// might block</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span> <span class="c1">//msg.targetæ˜¯å‘é€è¿™æ¡æ¶ˆæ¯çš„Handlerå¯¹è±¡</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Handler.java
     * Handle system messages here.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispatchMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">callback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleCallback</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mCallback</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="handleré€šè¿‡handlerå¼•ç”¨">Handler:é€šè¿‡handlerå¼•ç”¨</h2>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">SampleTask</span><span class="p">(</span><span class="kd">val</span> <span class="py">handler</span><span class="p">:</span> <span class="nc">Handler</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Runnable</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nc">Thread</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">msg</span> <span class="p">=</span> <span class="nf">prepareMessage</span><span class="p">(</span><span class="s">"task completed!"</span><span class="p">)</span>
            <span class="n">handler</span><span class="p">.</span><span class="nf">sendMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">InterruptedException</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="nc">TAG</span><span class="p">,</span> <span class="s">"interrupted!"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">prepareMessage</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Message</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">handler</span><span class="p">.</span><span class="nf">obtainMessage</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">data</span> <span class="p">=</span> <span class="nc">Bundle</span><span class="p">()</span>
        <span class="n">data</span><span class="p">.</span><span class="nf">putString</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="p">}</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kd">val</span> <span class="py">TAG</span> <span class="p">=</span> <span class="s">"SampleTask"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="handlerhandler">Handler:handler</h2>

<ul>
  <li>handleræ‰®æ¼”äº†å¾€MQä¸Šæ·»åŠ æ¶ˆæ¯å’Œå¤„ç†æ¶ˆæ¯çš„è§’è‰²ï¼ˆåªå¤„ç†ç”±è‡ªå·±å‘å‡ºçš„æ¶ˆæ¯ï¼‰</li>
  <li>é€šçŸ¥MQå®ƒè¦æ‰§è¡Œä¸€ä¸ªä»»åŠ¡(sendMessage)ï¼Œå¹¶åœ¨loopåˆ°è‡ªå·±çš„æ—¶å€™æ‰§è¡Œè¯¥ä»»åŠ¡(handleMessage)ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„</li>
  <li>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ªhandlerï¼Œ ä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªlooper</li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">LooperThread</span> <span class="p">:</span> <span class="nc">Thread</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">handler1</span><span class="p">:</span> <span class="nc">Handler</span>
    <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">handler2</span><span class="p">:</span> <span class="nc">Handler</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// å°†å½“å‰çº¿ç¨‹åˆå§‹åŒ–ä¸ºLooperçº¿ç¨‹</span>
        <span class="nc">Looper</span><span class="p">.</span><span class="nf">prepare</span><span class="p">()</span>

        <span class="n">handler1</span> <span class="p">=</span> <span class="nc">Handler</span><span class="p">()</span>
        <span class="n">handler2</span> <span class="p">=</span> <span class="nc">Handler</span><span class="p">()</span>

        <span class="c1">// å¼€å§‹å¾ªç¯å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—</span>
        <span class="nc">Looper</span><span class="p">.</span><span class="nf">loop</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="handler-sendconsumecooperate">handler: send/consume/cooperate</h2>

<h3 id="handlerå¯ä»¥åœ¨ä»»æ„çº¿ç¨‹å‘é€æ¶ˆæ¯è¿™äº›æ¶ˆæ¯ä¼šè¢«æ·»åŠ åˆ°å…³è”çš„mqä¸Š">handlerå¯ä»¥åœ¨<strong>ä»»æ„çº¿ç¨‹å‘é€æ¶ˆæ¯</strong>ï¼Œè¿™äº›æ¶ˆæ¯ä¼šè¢«æ·»åŠ åˆ°å…³è”çš„MQä¸Šã€‚</h3>
<p><img src="../images/handler_send_msg.png" alt="handler1.png" /></p>

<h3 id="handleræ˜¯åœ¨å®ƒå…³è”çš„looperçº¿ç¨‹ä¸­å¤„ç†æ¶ˆæ¯çš„">handleræ˜¯åœ¨å®ƒ<strong>å…³è”çš„looperçº¿ç¨‹ä¸­å¤„ç†æ¶ˆæ¯</strong>çš„ã€‚</h3>
<p><img src="../images/handler_consume_msg.png" alt="handler2.png" /></p>

<h3 id="åœ¨activityä¸­åˆ›å»ºhandlerå¹¶å°†å…¶å¼•ç”¨ä¼ é€’ç»™worker-threadworker-threadæ‰§è¡Œå®Œä»»åŠ¡åä½¿ç”¨handlerå‘é€æ¶ˆæ¯é€šçŸ¥activityæ›´æ–°ui">åœ¨activityä¸­åˆ›å»ºhandlerå¹¶å°†å…¶å¼•ç”¨ä¼ é€’ç»™worker threadï¼Œworker threadæ‰§è¡Œå®Œä»»åŠ¡åä½¿ç”¨handlerå‘é€æ¶ˆæ¯é€šçŸ¥activityæ›´æ–°UI</h3>

<p><img src="../images/handle_cooperate.png" alt="handler3.png" /></p>

<h2 id="handler-epoll">handler: epoll</h2>

<ul>
  <li>selectã€pollã€epolléƒ½æ˜¯IOå¤šè·¯å¤ç”¨
    <ul>
      <li>select-selectæ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤ªå°äº†ï¼Œé»˜è®¤æ˜¯1024ï¼Œ è½®è¯¢</li>
      <li>poll- æ²¡æœ‰æœ€å¤§è¿æ¥æ•°ï¼ŒåŸºäºé“¾è¡¨ï¼Œè½®è¯¢</li>
      <li>epoll- callback</li>
    </ul>
  </li>
  <li>epoll
    <ul>
      <li>epoll_create()ï¼š åˆ›å»ºä¸€ä¸ªepollå®ä¾‹å¹¶è¿”å›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦</li>
      <li>epoll_ctl()ï¼š æ³¨å†Œç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨</li>
      <li>epoll_wait()ï¼š å¯ä»¥ç”¨äºç­‰å¾…IOäº‹ä»¶ã€‚å¦‚æœå½“å‰æ²¡æœ‰å¯ç”¨çš„äº‹ä»¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹</li>
    </ul>
  </li>
</ul>

<h2 id="handler-handleråˆ›å»ºepoll">handler: handleråˆ›å»ºepoll</h2>

<ul>
  <li>è°ƒç”¨å…³ç³»
    <ul>
      <li>MessageQueueåˆå§‹åŒ–-&gt;nativeInit()-&gt;NativeMessageQueue()-&gt;Looper(false)-&gt;epoll_create-&gt;epoll_ctl</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="nl">Looper:</span><span class="o">:</span><span class="nc">Looper</span><span class="o">(</span><span class="n">bool</span> <span class="n">allowNonCallbacks</span><span class="o">)</span> <span class="o">:</span>
        <span class="n">mAllowNonCallbacks</span><span class="o">(</span><span class="n">allowNonCallbacks</span><span class="o">),</span> <span class="n">mSendingMessage</span><span class="o">(</span><span class="kc">false</span><span class="o">),</span>
        <span class="n">mResponseIndex</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">mNextMessageUptime</span><span class="o">(</span><span class="no">LLONG_MAX</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">wakeFds</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">(</span><span class="n">wakeFds</span><span class="o">);</span>
    <span class="no">LOG_ALWAYS_FATAL_IF</span><span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">"Could not create wake pipe.  errno=%d"</span><span class="o">,</span> <span class="n">errno</span><span class="o">);</span>

    <span class="n">mWakeReadPipeFd</span> <span class="o">=</span> <span class="n">wakeFds</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="n">mWakeWritePipeFd</span> <span class="o">=</span> <span class="n">wakeFds</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
	<span class="o">...</span>
    <span class="n">mIdling</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="c1">// Allocate the epoll instance and register the wake pipe.</span>
    <span class="n">mEpollFd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="o">(</span><span class="no">EPOLL_SIZE_HINT</span><span class="o">);</span>
    <span class="no">LOG_ALWAYS_FATAL_IF</span><span class="o">(</span><span class="n">mEpollFd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">,</span> <span class="s">"Could not create epoll instance.  errno=%d"</span><span class="o">,</span> <span class="n">errno</span><span class="o">);</span>

    <span class="n">struct</span> <span class="n">epoll_event</span> <span class="n">eventItem</span><span class="o">;</span>
    <span class="n">memset</span><span class="o">(&amp;</span> <span class="n">eventItem</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">epoll_event</span><span class="o">));</span> <span class="c1">// zero out unused members of data field union</span>
    <span class="n">eventItem</span><span class="o">.</span><span class="na">events</span> <span class="o">=</span> <span class="no">EPOLLIN</span><span class="o">;</span><span class="c1">//ç›‘å¬ç®¡é“çš„read()æ“ä½œ</span>
    <span class="n">eventItem</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">fd</span> <span class="o">=</span> <span class="n">mWakeReadPipeFd</span><span class="o">;</span><span class="c1">//è®°å½•ç®¡é“è¯»ç«¯çš„fd</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">epoll_ctl</span><span class="o">(</span><span class="n">mEpollFd</span><span class="o">,</span> <span class="no">EPOLL_CTL_ADD</span><span class="o">,</span> <span class="n">mWakeReadPipeFd</span><span class="o">,</span> <span class="o">&amp;</span> <span class="n">eventItem</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="handler-handlerä¸­looperé€šè¿‡è½®è¯¢è·å–message">handler: Handlerä¸­looperé€šè¿‡è½®è¯¢è·å–message</h2>

<ul>
  <li>Looper.loopä¸­forå¾ªç¯è·å–æ¶ˆæ¯
    <ul>
      <li>Message msg = queue.next();-&gt;nativePollOnce-&gt;nativeMessageQueue-&gt;pollOnce-&gt;pollInner()</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nl">Looper:</span><span class="o">:</span><span class="n">pollInner</span><span class="o">(</span><span class="kt">int</span> <span class="n">timeoutMillis</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">...</span>
    <span class="c1">// Poll.</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="no">POLL_WAKE</span><span class="o">;</span>
    <span class="n">mResponses</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">mResponseIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="c1">// We are about to idle.</span>
    <span class="n">mIdling</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="n">struct</span> <span class="n">epoll_event</span> <span class="n">eventItems</span><span class="o">[</span><span class="no">EPOLL_MAX_EVENTS</span><span class="o">];</span>
	<span class="c1">//ç­‰å¾…äº‹ä»¶å‘ç”Ÿæˆ–è€…è¶…æ—¶ï¼Œåœ¨nativeWake()æ–¹æ³•ï¼Œå‘ç®¡é“å†™ç«¯å†™å…¥å­—ç¬¦ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¿”å›ï¼›</span>
    <span class="kt">int</span> <span class="n">eventCount</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="o">(</span><span class="n">mEpollFd</span><span class="o">,</span> <span class="n">eventItems</span><span class="o">,</span> <span class="no">EPOLL_MAX_EVENTS</span><span class="o">,</span> <span class="n">timeoutMillis</span><span class="o">);</span>

    <span class="c1">// No longer idling.</span>
    <span class="n">mIdling</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="c1">// Acquire lock.</span>
    <span class="n">mLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
	<span class="o">...</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eventCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">eventItems</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">data</span><span class="o">.</span><span class="na">fd</span><span class="o">;</span>
        <span class="n">uint32_t</span> <span class="n">epollEvents</span> <span class="o">=</span> <span class="n">eventItems</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">events</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">==</span> <span class="n">mWakeReadPipeFd</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">epollEvents</span> <span class="o">&amp;</span> <span class="no">EPOLLIN</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">awoken</span><span class="o">();</span><span class="c1">//</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="no">ALOGW</span><span class="o">(</span><span class="s">"Ignoring unexpected epoll events 0x%x on wake read pipe."</span><span class="o">,</span> <span class="n">epollEvents</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
           <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="nl">Done:</span> <span class="o">;</span>

  <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æœ€ç»ˆè°ƒç”¨awaken</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nl">Looper:</span><span class="o">:</span><span class="n">awoken</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>
    <span class="n">ssize_t</span> <span class="n">nRead</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="c1">//ä¸æ–­è¯»å–ç®¡é“æ•°æ®ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†æ¸…ç©ºç®¡é“å†…å®¹</span>
        <span class="n">nRead</span> <span class="o">=</span> <span class="n">read</span><span class="o">(</span><span class="n">mWakeReadPipeFd</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">buffer</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">nRead</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="no">EINTR</span><span class="o">)</span> <span class="o">||</span> <span class="n">nRead</span> <span class="o">==</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">buffer</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æ€»ç»“
    <ul>
      <li>Looper::loopä¸­forå¾ªç¯ä¸æ–­è°ƒç”¨next()ä»è‡ªå·±çš„é“¾è¡¨ä¸­è·å–messageï¼Œä½†æ˜¯è·å–å‰å…ˆnativePollOnceè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾èµ„æºè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°ä¸‹ä¸ªæ¶ˆæ¯åˆ°è¾¾æˆ–è€…æœ‰äº‹åŠ¡å‘ç”Ÿï¼Œé€šè¿‡å¾€pipeç®¡é“å†™ç«¯å†™å…¥æ•°æ®æ¥å”¤é†’ä¸»çº¿ç¨‹å·¥ä½œ</li>
    </ul>
  </li>
</ul>

<h2 id="handler-handleré€šè¿‡sendmessageæœ€ç»ˆç»™ç®¡é“å†™æ•°æ®">handler: handleré€šè¿‡sendmessageæœ€ç»ˆç»™ç®¡é“å†™æ•°æ®</h2>
<p>å°†æ¶ˆæ¯pushåˆ°MessageQueueä¸­æ—¶å€™ï¼Œå³MessageQueue.enqueueMessages(â€¦)æ–¹æ³•ä¸­</p>

<ul>
  <li><strong>handler</strong>.sendMessage(msg)
    <ul>
      <li>sendMessageDelayed(msg, 0);
        <ul>
          <li>sendMessageAtTime(msg, SystemClock.<em>uptimeMillis</em>() + delayMillis);
            <ul>
              <li>enqueueMessage(queue, msg, uptimeMillis)
                <ul>
                  <li>queue.enqueueMessage(msg, uptimeMillis);å…ˆå…¥åˆ—åè°ƒç”¨wake
                    <ul>
                      <li><em>nativeWake</em>(<strong>mPtr</strong>);â€”&gt;
                        <ul>
                          <li>Looper-&gt;wake
                            <ul>
                              <li>write()</li>
                            </ul>
                          </li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nl">Looper:</span><span class="o">:</span><span class="n">wake</span><span class="o">()</span> <span class="o">{</span>
<span class="err">#</span><span class="k">if</span> <span class="no">DEBUG_POLL_AND_WAKE</span>
    <span class="nf">ALOGD</span><span class="o">(</span><span class="s">"%p ~ wake"</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="err">#</span><span class="n">endif</span>

    <span class="n">ssize_t</span> <span class="n">nWrite</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="n">nWrite</span> <span class="o">=</span> <span class="n">write</span><span class="o">(</span><span class="n">mWakeWritePipeFd</span><span class="o">,</span> <span class="s">"W"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span><span class="c1">//è¿›è¡Œäº†å†™æ“ä½œ</span>
    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">nWrite</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="no">EINTR</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">nWrite</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="no">EAGAIN</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">ALOGW</span><span class="o">(</span><span class="s">"Could not write wake signal, errno=%d"</span><span class="o">,</span> <span class="n">errno</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><strong>handler</strong>.postDelayed(runnable, time)
    <ul>
      <li>sendMessageDelayed(<em>getPostMessage</em>(r), delayMillis);
        <ul>
          <li>åŒä¸Š</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>handler.postDelayå¹¶ä¸æ˜¯å…ˆç­‰å¾…ä¸€å®šçš„æ—¶é—´å†æ”¾å…¥åˆ°MessageQueueä¸­ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥MessageQueueï¼Œä»¥MessageQueueçš„æ—¶é—´é¡ºåºæ’åˆ—å’Œå”¤é†’çš„æ–¹å¼ç»“åˆå®ç°çš„
    <ul>
      <li>MessageQueueçš„next()æ–¹æ³•ï¼Œä¼šæ ¹æ®å…¶delayæ—¶é—´å’Œé“¾è¡¨å¤´çš„æ¯”è¾ƒï¼Œå¦‚æœæ›´çŸ­åˆ™ï¼Œæ”¾å…¥é“¾è¡¨å¤´ï¼Œå¹¶ä¸”çœ‹æ—¶é—´æ˜¯å¦æœ‰delayï¼Œ
        <ul>
          <li>å¦‚æœæœ‰ï¼Œåˆ™blockï¼Œç­‰å¾…æ—¶é—´åˆ°æ¥å”¤é†’æ‰§è¡Œï¼Œ
            <ul>
              <li>Â Looper::pollInner(int timeoutMillis)
                <ul>
                  <li>epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</li>
                </ul>
              </li>
            </ul>
          </li>
          <li>å¦åˆ™å°†å”¤é†’ç«‹å³æ‰§è¡Œã€‚</li>
        </ul>
      </li>
      <li>epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis)
        <ul>
          <li>timeoutMillis == -1,Â causes <strong>epoll_wait</strong>() to block indefinitely,</li>
          <li>timeoutMillis == 0,Â cause <strong>epoll_wait</strong>() to return immediately</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>å‘é€æ¶ˆæ¯, MessageQueue.enqueueMessage(Message msg, **long **when)ä¼šæ ¹æ®æ—¶é—´æŠŠmessageæ’å…¥åˆ°åˆé€‚ä½ç½®
    <ul>
      <li>sendMessageAtFrontOfQueue //æ’å…¥åˆ°é˜Ÿåˆ—é¦–éƒ¨
        <ul>
          <li>enqueueMessage(queue, msg, 0); //æœ€åçš„å‚æ•°uptimeMillisæ˜¯0ï¼Œä¿è¯äº†åœ¨é˜Ÿé¦–</li>
        </ul>
      </li>
      <li>postDelayed
        <ul>
          <li>sendMessageDelayed(<em>getPostMessage</em>(r), delayMillis)
            <ul>
              <li>sendMessageAtTime(msg, SystemClock.<em>uptimeMillis</em>() + delayMillis); //boot 2 now+delay
                <ul>
                  <li>enqueueMessage(queue, msg, uptimeMillis);</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>sendMessage(Message msg)
        <ul>
          <li>sendMessageDelayed(msg, 0)
            <ul>
              <li>sendMessageAtTime(msg, SystemClock.<em>uptimeMillis</em>() + delayMillis);
                <ul>
                  <li>//åŒä¸Š</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="sendæ€»ç»“">sendæ€»ç»“</h3>
<ul>
  <li>æ¶ˆæ¯æ˜¯é€šè¿‡MessageQueenä¸­çš„enqueueMessage()æ–¹æ³•åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ï¼Œå¹¶ä¸”å®ƒåœ¨æ”¾å…¥ä¸­å°±è¿›è¡Œå¥½æ’åºï¼Œé“¾è¡¨å¤´çš„å»¶è¿Ÿæ—¶é—´å°ï¼Œå°¾éƒ¨å»¶è¿Ÿæ—¶é—´æœ€å¤§</li>
  <li>enqueueMessageâ€“éå»¶è¿Ÿæ¶ˆæ¯
    <ul>
      <li>æ’å…¥å¤´éƒ¨ï¼Œç„¶åå”¤é†’</li>
    </ul>
  </li>
  <li>enqueueMessageâ€“å»¶è¿Ÿæ¶ˆæ¯
    <ul>
      <li>æ’å…¥åˆé€‚ä½ç½®ï¼Œç„¶åå”¤é†’</li>
    </ul>
  </li>
</ul>
:ET